# 任务011: 集成测试 undo/redo 完整流程

**状态**: Todo
**优先级**: P2
**预计时间**: 30 分钟

## 任务描述

使用 tmux 在临时测试环境中执行完整的 undo/redo 流程测试，验证所有功能正常工作。

## 验收标准

- [ ] 命令注册成功
- [ ] `/undo` 命令能正确回退文件
- [ ] `/redo` 命令能正确恢复文件
- [ ] RevertInfo 组件正确显示
- [ ] 多次 undo/redo 正常工作
- [ ] 状态持久化正确

## 实施步骤

1. **启动 tmux 会话**
   ```bash
   bun ~/.pi/agent/skills/tmux/lib.ts create checkpoint-test "cd /tmp/checkpoint-v2-test && pi --extension ~/.pi/agent/extensions/checkpoint-v2/index.ts" task
   ```

2. **测试用例 1: 基本修改和 undo**
   ```
   # 在 tmux 中执行
   1. 启动 pi
   2. 输入: 编辑 test1.ts，添加一行注释
   3. 执行: /changes
   4. 验证: 显示 test1.ts 被修改
   5. 执行: /undo
   6. 验证: RevertInfo 显示，test1.ts 恢复原状
   7. 验证: 显示 redo 提示
   8. 执行: /redo
   9. 验证: test1.ts 恢复修改后的状态
   10. 执行: /undo
   11. 验证: 可以再次 undo
   ```

3. **测试用例 2: 多次 undo/redo**
   ```
   # 在 tmux 中执行
   1. Turn 1: 修改 test1.ts
   2. Turn 2: 修改 test2.ts
   3. Turn 3: 创建 test3.ts
   4. 执行: /changes
   5. 验证: 显示 3 个文件的变化
   6. 执行: /undo
   7. 验证: test3.ts 被删除
   8. 执行: /undo
   9. 验证: test2.ts 恢复原状
   10. 执行: /undo
   11. 验证: test1.ts 恢复原状
   12. 执行: /redo
   13. 验证: test1.ts 恢复修改
   14. 执行: /redo
   15. 验证: test2.ts 恢复修改
   16. 执行: /redo
   17. 验证: test3.ts 被重新创建
   ```

4. **测试用例 3: 边界情况**
   ```
   # 在 tmux 中执行
   1. 执行: /undo（没有任何修改）
   2. 验证: 显示 "Nothing to undo"
   3. 修改 test1.ts
   4. 执行: /undo
   5. 执行: /undo（再次 undo，到达初始状态）
   6. 验证: 显示 "Nothing to undo"
   7. 执行: /redo
   8. 验证: test1.ts 恢复
   9. 执行: /redo（再次 redo，没有更多可 redo）
   10. 验证: 显示 "Nothing to redo"
   ```

5. **测试用例 4: RevertInfo 组件**
   ```
   # 在 tmux 中执行
   1. 修改 test1.ts、test2.ts、创建 test3.ts
   2. 执行: /undo
   3. 验证: RevertInfo 显示 "1 message reverted"
   4. 验证: 显示 3 个文件的列表
   5. 验证: 每个文件显示统计信息
   6. 验证: 显示 "Press /redo to restore"
   7. 按 Escape 关闭组件
   ```

6. **测试用例 5: 状态持久化**
   ```
   # 在 tmux 中执行
   1. 修改 test1.ts
   2. 执行: /undo
   3. 退出 pi
   4. 重新启动 pi（同一会话）
   5. 执行: /redo
   6. 验证: 可以 redo（状态已持久化）
   ```

7. **记录测试结果**
   ```bash
   # 创建测试报告
   cat > /tmp/checkpoint-v2-test/TEST_REPORT.md << 'EOF'
   # Checkpoint V2 集成测试报告

   ## 测试环境
   - 时间: $(date)
   - 目录: /tmp/checkpoint-v2-test

   ## 测试结果

   | 用例 | 状态 | 备注 |
   |------|------|------|
   | 基本修改和 undo | ⬜ | |
   | 多次 undo/redo | ⬜ | |
   | 边界情况 | ⬜ | |
   | RevertInfo 组件 | ⬜ | |
   | 状态持久化 | ⬜ | |

   ## 发现的问题

   - [问题描述]

   ## 总结

   [测试总结]
   EOF
   ```

8. **清理 tmux 会话**
   ```bash
   bun ~/.pi/agent/skills/tmux/lib.ts kill checkpoint-test
   ```

## 依赖任务

- 001: 修复 CheckpointManager undo/redo 命名错误
- 002: 统一 timestamp 单位
- 003: 修复 turn_end 缺少 await
- 008: 集成 RevertInfo 组件到 undo/redo 命令
- 010: 设置临时测试环境

## 阻塞原因

等待任务 001、002、003、008、010 完成

## 备注

- 使用 tmux 的 send 功能发送命令
- 可以使用 `bun ~/.pi/agent/skills/tmux/lib.ts capture checkpoint-test` 查看输出
- 测试时注意观察控制台日志
- 发现问题及时记录并修复
- 建议录制测试过程或保存关键输出