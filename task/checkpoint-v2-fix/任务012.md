# 任务012: 集成测试 /changes 命令和 TUI 组件

**状态**: Todo
**优先级**: P2
**预计时间**: 30 分钟

## 任务描述

使用 tmux 在临时测试环境中执行 `/changes` 命令和 TUI 组件的完整测试，验证文件列表显示和 diff 查看功能正常工作。

## 验收标准

- [ ] `/changes` 命令正常工作
- [ ] FileChangesViewer 正确显示文件列表
- [ ] 文件统计信息（additions/deletions）正确
- [ ] 选择文件后显示 diff
- [ ] DiffViewer 正确显示 diff
- [ ] 键盘导航和滚动正常工作
- [ ] 可以返回文件列表

## 实施步骤

1. **启动 tmux 会话**
   ```bash
   bun ~/.pi/agent/skills/tmux/lib.ts create checkpoint-changes-test "cd /tmp/checkpoint-v2-test && pi --extension ~/.pi/agent/extensions/checkpoint-v2/index.ts" task
   ```

2. **测试用例 1: 基本文件列表显示**
   ```
   # 在 tmux 中执行
   1. 启动 pi
   2. Turn 1: 修改 test1.ts（添加 2 行）
   3. Turn 2: 修改 test2.ts（删除 1 行，添加 3 行）
   4. Turn 3: 创建 test3.ts（添加 5 行）
   5. 执行: /changes
   6. 验证: 显示文件列表
   7. 验证: 显示 3 个文件
   8. 验证: test1.ts 显示 "+2"
   9. 验证: test2.ts 显示 "-1 +3"
   10. 验证: test3.ts 显示 "+5"
   11. 按 Escape 退出
   ```

3. **测试用例 2: 文件选择和 diff 显示**
   ```
   # 在 tmux 中执行
   1. 确保 test1.ts 已修改
   2. 执行: /changes
   3. 验证: 显示文件列表
   4. 选择: test1.ts（按 Enter）
   5. 验证: 显示 DiffViewer 组件
   6. 验证: 显示正确的 diff 内容
   7. 验证: 行号正确显示
   8. 验证: 添加的行显示绿色
   9. 验证: 删除的行显示红色
   10. 按 Escape 返回文件列表
   11. 按 Escape 退出
   ```

4. **测试用例 3: DiffViewer 键盘导航**
   ```
   # 在 tmux 中执行
   1. 修改 test1.ts（添加 30 行，使 diff 很长）
   2. 执行: /changes
   3. 选择: test1.ts
   4. 验证: 进入 DiffViewer
   5. 按: ↓（向下箭头）
   6. 验证: diff 向下滚动
   7. 按: ↑（向上箭头）
   8. 验证: diff 向上滚动
   9. 按: Page Down
   10. 验证: diff 向下滚动半屏
   11. 按: Page Up
   12. 验证: diff 向上滚动半屏
   13. 按: Home
   14. 验证: diff 滚动到顶部
   15. 按: End
   16. 验证: diff 滚动到底部
   17. 按: Escape
   18. 验证: 返回文件列表
   ```

4. **测试用例 4: 新文件和删除文件的 diff**
   ```
   # 在 tmux 中执行
   1. 创建 test-new.ts（新文件，10 行）
   2. 删除 test2.ts
   3. 执行: /changes
   4. 选择: test-new.ts
   5. 验证: 显示 "new file mode 100644"
   6. 验证: 显示所有内容为添加的行（绿色）
   7. 按 Escape 返回
   8. 选择: test2.ts
   9. 验证: 显示删除的文件 diff
   10. 验证: 显示删除的行（红色）
   11. 按 Escape 返回
   12. 按 Escape 退出
   ```

5. **测试用例 5: 无变化情况**
   ```
   # 在 tmux 中执行
   1. 执行: /changes（没有任何文件修改）
   2. 验证: 显示 "No file changes in current session"
   ```

6. **测试用例 6: 多文件 diff 查看**
   ```
   # 在 tmux 中执行
   1. 修改 test1.ts
   2. 修改 test2.ts
   3. 创建 test3.ts
   4. 执行: /changes
   5. 选择: test1.ts，查看 diff
   6. 按 Escape 返回
   7. 选择: test2.ts，查看 diff
   8. 按 Escape 返回
   9. 选择: test3.ts，查看 diff
   10. 按 Escape 返回
   11. 按 Escape 退出
   ```

7. **记录测试结果**
   ```bash
   # 更新测试报告
   cat >> /tmp/checkpoint-v2-test/TEST_REPORT.md << 'EOF'

   ## /changes 命令测试

   | 用例 | 状态 | 备注 |
   |------|------|------|
   | 基本文件列表显示 | ⬜ | |
   | 文件选择和 diff 显示 | ⬜ | |
   | DiffViewer 键盘导航 | ⬜ | |
   | 新文件和删除文件的 diff | ⬜ | |
   | 无变化情况 | ⬜ | |
   | 多文件 diff 查看 | ⬜ | |

   TUI 组件测试结果:
   [测试结果]
   EOF
   ```

8. **清理 tmux 会话**
   ```bash
   bun ~/.pi/agent/skills/tmux/lib.ts kill checkpoint-changes-test
   ```

## 依赖任务

- 005: 统一命令名称（/view → /changes）
- 009: 为 FileChangesViewer 添加 diff 功能
- 010: 设置临时测试环境

## 阻塞原因

等待任务 005、009、010 完成

## 备注

- 测试时注意观察文件统计信息是否正确
- 确认 diff 格式正确，颜色显示清晰
- 测试各种边界情况（空文件、大文件、二进制文件等）
- 记录任何 UI 问题或用户体验问题
- 测试完成后更新 README.md 文档