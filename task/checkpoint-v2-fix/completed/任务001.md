# 任务001: 修复 CheckpointManager undo/redo 命名错误

**状态**: Todo
**优先级**: P0
**预计时间**: 15 分钟

## 任务描述

修复 `CheckpointManager` 中 `undoStack` 和 `redoStack` 的命名错误，当前命名与实际功能相反。

## 问题分析

```typescript
// 当前错误实现
private state: CheckpointState = {
  history: [],
  undoStack: [],  // ❌ 实际存储被 undo 的 checkpoint（用于 redo）
  redoStack: [],  // ❌ 从未使用
};

undo(): CheckpointData | null {
  const current = this.state.history.pop()!;
  this.state.undoStack.push(current);  // 应该叫 redoStack
  // ...
}

redo(): CheckpointData | null {
  const checkpoint = this.state.undoStack.pop()!;  // 从 undoStack 取出？
  // ...
}
```

## 验收标准

- [ ] `undoStack` 重命名为 `redoStack`（存储被 undo 的 checkpoint）
- [ ] `redoStack` 重命名为 `undoStack`（存储被 redo 的 checkpoint，如果需要）
- [ ] `undo()` 方法正确将当前 checkpoint 移到 redoStack
- [ ] `redo()` 方法正确从 redoStack 取出 checkpoint 并移回 history
- [ ] `canUndo()` 方法逻辑正确
- [ ] `canRedo()` 方法逻辑正确
- [ ] 所有测试通过

## 实施步骤

1. **重命名字段**
   ```typescript
   private state: CheckpointState = {
     currentTurnIndex: 0,
     history: [],
     redoStack: [],  // 存储 undo 过的 checkpoint，用于 redo
     undoStack: [],  // 存储 redo 过的 checkpoint，用于再次 undo（如果需要）
   };
   ```

2. **修复 undo() 方法**
   ```typescript
   undo(): CheckpointData | null {
     if (this.state.history.length <= 1) {
       return null;
     }

     const current = this.state.history.pop()!;
     this.state.redoStack.push(current);  // 移到 redoStack

     const previous = this.state.history[this.state.history.length - 1];
     if (previous) {
       this.state.currentTurnIndex = previous.turnIndex;
     }

     return previous;
   }
   ```

3. **修复 redo() 方法**
   ```typescript
   redo(): CheckpointData | null {
     if (this.state.redoStack.length === 0) {
       return null;
     }

     const checkpoint = this.state.redoStack.pop()!;
     this.state.history.push(checkpoint);

     this.state.currentTurnIndex = checkpoint.turnIndex;

     return checkpoint;
   }
   ```

4. **修复 canUndo() 和 canRedo()**
   ```typescript
   canUndo(): boolean {
     return this.state.history.length > 1;
   }

   canRedo(): boolean {
     return this.state.redoStack.length > 0;
   }
   ```

5. **修复其他使用这些字段的方法**
   - `setState()` 方法
   - `removeCheckpoint()` 方法
   - `validate()` 方法

6. **测试验证**
   - 创建 checkpoint
   - 执行 undo，验证 redoStack 有值，canRedo() 返回 true
   - 执行 redo，验证 checkpoint 回到 history
   - 执行多次 undo/redo，验证状态正确

## 依赖任务

无

## 阻塞原因

无

## 备注

- 这是一个简单的命名问题，修改后需要仔细检查所有使用这些字段的地方
- 建议先阅读完整的 `checkpoint-manager.ts` 文件，确保没有遗漏