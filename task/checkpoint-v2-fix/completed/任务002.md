# 任务002: 统一 timestamp 单位（使用毫秒）

**状态**: Todo
**优先级**: P0
**预计时间**: 10 分钟

## 任务描述

统一代码中 `timestamp` 字段的单位，全部使用毫秒，避免混用秒和毫秒导致的错误。

## 问题分析

```typescript
// utils.ts - 返回秒
export function getCurrentTimestamp(): number {
  return Math.floor(Date.now() / 1000);
}

// git-storage.ts - loadCheckpoint() 将 ISO 转为秒
const isoTimestamp = line.slice(10);
timestamp = new Date(isoTimestamp).getTime() / 1000;  // 除以 1000 得到秒

// 但其他地方可能直接使用 Date.now() 返回毫秒
```

## 验收标准

- [ ] `getCurrentTimestamp()` 返回毫秒（不除以 1000）
- [ ] `formatTimestamp()` 接收毫秒参数
- [ ] `git-storage.ts` 中所有 timestamp 使用毫秒
- [ ] `checkpoint-manager.ts` 中所有 timestamp 使用毫秒
- [ ] `types.ts` 中所有 timestamp 类型定义明确为毫秒
- [ ] 所有时间比较逻辑正确

## 实施步骤

1. **修复 utils.ts**
   ```typescript
   // 修改前
   export function getCurrentTimestamp(): number {
     return Math.floor(Date.now() / 1000);
   }

   // 修改后
   export function getCurrentTimestamp(): number {
     return Date.now();
   }

   // 修改前
   export function formatTimestamp(timestamp: number): string {
     return new Date(timestamp * 1000).toISOString();
   }

   // 修改后
   export function formatTimestamp(timestamp: number): string {
     return new Date(timestamp).toISOString();
   }
   ```

2. **修复 git-storage.ts**
   ```typescript
   // createSnapshot() - 已经是毫秒，无需修改
   const timestamp = getCurrentTimestamp();
   const isoTimestamp = formatTimestamp(timestamp);

   // loadCheckpoint() - 修复
   // 修改前
   timestamp = new Date(isoTimestamp).getTime() / 1000;

   // 修改后
   timestamp = new Date(isoTimestamp).getTime();
   ```

3. **更新类型定义注释**
   ```typescript
   // types.ts
   export interface CheckpointData {
     /** Creation timestamp in milliseconds */
     timestamp: number;
     // ...
   }
   ```

4. **检查所有时间比较逻辑**
   ```typescript
   // 确保所有比较都使用毫秒
   if (checkpoint.timestamp < cutoffTimestamp) { ... }
   ```

5. **测试验证**
   - 创建 checkpoint，检查 timestamp 值
   - 加载 checkpoint，检查 timestamp 值
   - 验证时间比较逻辑正确

## 依赖任务

无

## 阻塞原因

无

## 备注

- 统一使用毫秒可以避免精度丢失
- JavaScript `Date.now()` 默认返回毫秒，这是标准做法
- 修改后建议运行一次完整的测试流程