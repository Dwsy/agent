# 任务004: 修复 cleanupLock 正则表达式

**状态**: Todo
**优先级**: P1
**预计时间**: 10 分钟

## 任务描述

修复 `index.ts` 中 `cleanupLock` 函数的正则表达式，使其能正确匹配 `~/.pt/git/<hash>/index.lock` 路径。

## 问题分析

```typescript
// index.ts - cleanupLock
const gitDirMatch = lockPath.match(/\.git\/[^/]+$/)?.[0];
// lockPath 实际是: ~/.pt/git/<hash>/index.lock
// 正则永远不会匹配！
```

## 验收标准

- [ ] 正则表达式能正确匹配 `~/.pt/git/<hash>/index.lock`
- [ ] 正确提取 git 目录路径
- [ ] lock 文件能被正确删除

## 实施步骤

1. **分析 lock 文件路径格式**
   ```
   ~/.pt/git/<hash>/index.lock
   ```

2. **修复正则表达式**
   ```typescript
   // 修改前
   const gitDirMatch = lockPath.match(/\.git\/[^/]+$/)?.[0];

   // 修改后 - 方案 1：直接删除 lock 文件
   await pi.exec('rm', ['-f', lockPath], { cwd: ctx.cwd });

   // 修改后 - 方案 2：提取 git 目录（如果需要）
   const lockMatch = lockPath.match(/^(.*)\/index\.lock$/);
   if (lockMatch) {
     const lockDir = lockMatch[1];
     console.log(`[Checkpoint V2] Lock file at: ${lockPath}`);
   }
   ```

3. **简化 cleanupLock 函数**
   ```typescript
   cleanupLock: async (lockPath: string) => {
     try {
       console.log(`[Checkpoint V2] Cleaning lock file: ${lockPath}`);
       await pi.exec('rm', ['-f', lockPath], { cwd: ctx.cwd });
       console.log(`[Checkpoint V2] Lock file removed`);
     } catch (error) {
       console.log(`[Checkpoint V2] Failed to remove lock file: ${error}`);
     }
   }
   ```

4. **检查 git-storage.ts 中的锁清理**
   ```typescript
   // git-storage.ts - createSnapshot
   try {
     if (require('fs').existsSync(lockPath)) {
       console.log('[Checkpoint V2] Cleaning lock file synchronously');
       spawnSync('rm', ['-f', lockPath]);
       console.log('[Checkpoint V2] Lock file removed');
     }
   } catch (error) {
     console.log(`[Checkpoint V2] Lock cleanup sync failed: ${error}`);
   }
   ```

5. **测试验证**
   - 创建 checkpoint，观察 lock 文件处理
   - 确认 lock 文件被正确删除

## 依赖任务

无

## 阻塞原因

无

## 备注

- 当前正则表达式永远不会匹配，但锁文件清理仍能工作（因为直接使用 lockPath）
- 建议简化代码，删除不必要的正则匹配
- 如果确实需要提取 git 目录，使用正确的正则表达式