# 任务009: 为 FileChangesViewer 添加 diff 功能

**状态**: Todo
**优先级**: P2
**预计时间**: 30 分钟

## 任务描述

为 `FileChangesViewer` 组件添加 diff 功能，当用户选择文件后显示该文件的变化详情。

## 当前状态

- `FileChangesViewer` 可以显示文件列表
- `DiffViewer` 组件已实现但未集成
- 用户选择文件后没有后续操作

## 验收标准

- [ ] 用户选择文件后显示 diff
- [ ] 使用 DiffViewer 组件显示 diff
- [ ] 支持返回文件列表（按 Escape）
- [ ] 正确生成 git diff 输出
- [ ] 滚动和键盘导航正常工作

## 实施步骤

1. **分析当前 FileChangesViewer 实现**
   ```typescript
   // file-changes-viewer.ts
   this.selectList.onSelect = (item: any) => {
     if (this.onSelect) this.onSelect(item.value);
     this.onDone(item.value);  // 返回选中的文件
   };
   ```

2. **修改 commands.ts 中的 handleView**
   ```typescript
   async function handleView(
     fileTracker: FileTracker | null,
     checkpointManager: CheckpointManager | null,
     ctx: any
   ): Promise<void> {
     try {
       console.log('[Checkpoint V2] /changes command - handleView called');

       if (!fileTracker && !checkpointManager) {
         console.log('[Checkpoint V2] No fileTracker or checkpointManager');
         ctx.ui.notify('Checkpoint system not initialized. Please start a session first.', 'warning');
         return;
       }

       await ctx.waitForIdle();

       // 获取文件变化
       const currentChanges = fileTracker ? fileTracker.getChanges() : [];
       const allChanges = checkpointManager ? checkpointManager.getAllFileChanges() : [];
       const changes = currentChanges.length > 0 ? currentChanges : allChanges;

       if (changes.length === 0) {
         ctx.ui.notify('No file changes in current session', 'info');
         return;
       }

       // 显示文件列表和 diff
       const { FileChangesViewer } = await import('./components/file-changes-viewer.js');
       const { DiffViewer } = await import('./components/diff-viewer.js');

       // 双视图模式：文件列表 → diff 详情
       let selectedFile: FileChange | null = null;

       while (true) {
         // 显示文件列表
         selectedFile = await ctx.ui.custom<FileChange | null>((tui, theme, done) => {
           return new FileChangesViewer(changes, theme, tui, done);
         }, {
           overlay: true,
           overlayOptions: {
             width: '80%',
             maxHeight: 20,
           }
         });

         // 用户取消选择
         if (!selectedFile) {
           break;
         }

         console.log('[Checkpoint V2] Selected file:', selectedFile.path);

         // 生成 diff
         let diffText = '';
         try {
           // 获取文件 diff
           const diffResult = await pi.exec('git', ['diff', '--', selectedFile.path], { cwd: ctx.cwd });
           diffText = diffResult.stdout;

           if (!diffText) {
             // 文件可能是新创建的，尝试显示空文件
             diffText = `diff --git a/${selectedFile.path} b/${selectedFile.path}\nnew file mode 100644\n`;
           }
         } catch (error) {
           diffText = `Error generating diff: ${error}`;
         }

         // 显示 diff
         await ctx.ui.custom<null>((tui, theme, _kb, done) => {
           return new DiffViewer(
             {
               diff: diffText,
               theme,
               maxHeight: 30,
               showLineNumbers: true,
             },
             tui,
             done
           );
         }, {
           overlay: true,
           overlayOptions: {
             width: '100%',
             maxHeight: 30,
           }
         });

         // 用户关闭 diff，返回文件列表（循环继续）
       }

       console.log('[Checkpoint V2] File viewer closed');
     } catch (error) {
       console.error('[Checkpoint V2] /changes command error:', error);
       ctx.ui.notify(
         `View failed: ${error instanceof Error ? error.message : String(error)}`,
         'error'
       );
     }
   }
   ```

3. **优化 diff 生成逻辑**
   ```typescript
   // 添加辅助函数
   async function generateFileDiff(filePath: string, cwd: string): Promise<string> {
     try {
       // 检查文件是否在 git 中
       const lsResult = await pi.exec('git', ['ls-files', filePath], { cwd });
       if (!lsResult.stdout.trim()) {
         // 新文件
         const catResult = await pi.exec('cat', [filePath], { cwd });
         return `diff --git a/${filePath} b/${filePath}\nnew file mode 100644\n--- /dev/null\n+++ b/${filePath}\n${catResult.stdout.split('\n').map(l => '+' + l).join('\n')}`;
       }

       // 已存在的文件
       const diffResult = await pi.exec('git', ['diff', '--', filePath], { cwd });
       return diffResult.stdout;
     } catch (error) {
       return `Error generating diff: ${error}`;
     }
   }
   ```

4. **测试验证**
   - 执行 `/changes` 命令
   - 选择一个修改的文件，查看 diff
   - 按 Escape 返回文件列表
   - 选择另一个文件，查看 diff
   - 在文件列表中按 Escape 退出

## 依赖任务

- 007: 修复 DiffViewer 键码处理

## 阻塞原因

等待任务 007 完成

## 备注

- 这是一个增强功能，提升用户体验
- 需要正确处理新文件、修改文件和删除文件的 diff
- 建议先修复 DiffViewer 的键码问题，再集成此功能