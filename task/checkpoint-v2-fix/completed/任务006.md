# 任务006: 修复 FileTracker stats 更新逻辑

**状态**: Todo
**优先级**: P1
**预计时间**: 20 分钟

## 任务描述

实现 `FileTracker.updateFileStats()` 方法的调用逻辑，确保文件变化统计（additions/deletions）能正确更新。

## 问题分析

```typescript
// file-tracker.ts - 方法定义了但从未被调用
updateFileStats(path: string, additions: number, deletions: number): void {
  const normalizedPath = this.normalizePath(path);
  const existing = this.changes.get(normalizedPath);

  if (existing) {
    this.changes.set(normalizedPath, {
      ...existing,
      additions: (existing.additions || 0) + additions,
      deletions: (existing.deletions || 0) + deletions,
    });
  }
}

// 但从未调用
```

## 验收标准

- [ ] `updateFileStats()` 方法被正确调用
- [ ] additions/deletions 统计准确
- [ ] 从 git diff --numstat 获取统计数据
- [ ] FileChangesViewer 显示正确的统计信息

## 实施步骤

1. **分析如何获取文件变化统计**
   - 方案 1: 从 `tool_result` 事件中提取（edit 工具返回 diff）
   - 方案 2: 在 `turn_end` 时调用 `git diff --numstat` 获取
   - 方案 3: 在 `trackFile()` 后调用 `git diff` 获取单个文件变化

2. **实现方案 2（推荐）**
   ```typescript
   // index.ts - turn_end 事件
   pi.on('turn_end', async (event: any, ctx: any) => {
     if (!fileTracker || !gitStorage || !checkpointManager) return;

     const changes = fileTracker.getChanges();
     if (changes.length === 0) {
       return;
     }

     try {
       // 获取文件变化统计
       const statsResult = await pi.exec('git', ['diff', '--numstat'], { cwd: ctx.cwd });
       const stats = parseGitNumstat(statsResult.stdout);

       // 更新 fileTracker 的统计
       for (const stat of stats) {
         const fileChange = fileTracker.getFileChange(stat.path);
         if (fileChange) {
           fileTracker.updateFileStats(stat.path, stat.additions, stat.deletions);
         }
       }

       // 创建 checkpoint
       const checkpoint = await gitStorage.createSnapshot(
         currentSessionId,
         event.turnIndex,
         fileTracker.getChanges()  // 包含更新后的统计
       );

       // ...
     } catch (error) {
       // ...
     }
   });
   ```

3. **添加 parseGitNumstat 到 utils.ts**
   ```typescript
   // utils.ts 中已有此函数，确认正确
   export function parseGitNumstat(output: string): Array<{
     path: string;
     additions: number;
     deletions: number;
   }>
   ```

4. **在 FileTracker 中添加批量更新方法**
   ```typescript
   // file-tracker.ts
   /**
    * Update file stats from git numstat output
    */
   updateFileStatsFromGit(stats: Array<{ path: string; additions: number; deletions: number }>): void {
     for (const stat of stats) {
       const normalizedPath = this.normalizePath(stat.path);
       const existing = this.changes.get(normalizedPath);

       if (existing) {
         this.changes.set(normalizedPath, {
           ...existing,
           additions: stat.additions,
           deletions: stat.deletions,
         });
       }
     }
   }
   ```

5. **测试验证**
   - 修改文件，检查 additions/deletions 是否正确
   - 创建新文件，检查统计是否正确
   - 删除文件，检查统计是否正确
   - 查看 /changes 命令输出，确认统计显示正确

## 依赖任务

无

## 阻塞原因

无

## 备注

- 使用 `git diff --numstat` 是获取文件变化统计的最可靠方法
- 需要在 git add 之前执行 git diff，否则 diff 为空
- 统计信息对于用户体验很重要，应该优先修复