# 任务008: 集成 RevertInfo 组件到 undo/redo 命令

**状态**: Todo
**优先级**: P2
**预计时间**: 20 分钟

## 任务描述

将 `RevertInfo` 组件集成到 `/undo` 和 `/redo` 命令中，在执行 undo/redo 后显示回退状态和文件变化摘要。

## 当前状态

- `RevertInfo` 组件已实现但从未使用
- `/undo` 和 `/redo` 命令只显示简单的通知消息

## 验收标准

- [ ] `/undo` 命令执行后显示 RevertInfo 组件
- [ ] `/redo` 命令执行后显示 RevertInfo 组件
- [ ] 显示回退的文件数量和摘要
- [ ] 显示 redo 提示（如果有文件被回退）
- [ ] 组件可以按 Escape 关闭

## 实施步骤

1. **修改 commands.ts 中的 handleUndo**
   ```typescript
   async function handleUndo(
     pi: ExtensionAPI,
     checkpointManager: CheckpointManager | null,
     getGitStorage: () => GitStorage | null,
     ctx: any
   ): Promise<void> {
     try {
       if (!checkpointManager) {
         ctx.ui.notify('Checkpoint system not initialized. Please start a session first.', 'warning');
         return;
       }

       await ctx.waitForIdle();

       if (!checkpointManager.canUndo()) {
         ctx.ui.notify('Nothing to undo', 'warning');
         return;
       }

       const previousCheckpoint = checkpointManager.undo();
       if (!previousCheckpoint) {
         ctx.ui.notify('No previous checkpoint found', 'warning');
         return;
       }

       const gitStorage = getGitStorage();
       if (!gitStorage) {
         ctx.ui.notify('Git storage not available', 'error');
         return;
       }

       await gitStorage.restore(previousCheckpoint.gitRef);

       pi.appendEntry('checkpoint-state', checkpointManager.getState());

       // 显示 RevertInfo 组件
       const { RevertInfo } = await import('./components/revert-info.js');

       await ctx.ui.custom<null>((tui, theme, _kb, done) => {
         return new RevertInfo(
           {
             revertedMessages: 1,
             files: previousCheckpoint.files,
             showHint: checkpointManager.canRedo(),
             theme,
           },
           tui,
           done
         );
       }, {
         overlay: true,
         overlayOptions: {
           anchor: 'top',
           width: '80%',
           maxHeight: 20,
         }
       });
     } catch (error) {
       ctx.ui.notify(
         `Undo failed: ${error instanceof Error ? error.message : String(error)}`,
         'error'
       );
     }
   }
   ```

2. **修改 commands.ts 中的 handleRedo**
   ```typescript
   async function handleRedo(
     pi: ExtensionAPI,
     checkpointManager: CheckpointManager | null,
     getGitStorage: () => GitStorage | null,
     ctx: any
   ): Promise<void> {
     try {
       if (!checkpointManager) {
         ctx.ui.notify('Checkpoint system not initialized. Please start a session first.', 'warning');
         return;
       }

       await ctx.waitForIdle();

       if (!checkpointManager.canRedo()) {
         ctx.ui.notify('Nothing to redo', 'warning');
         return;
       }

       const redoCheckpoint = checkpointManager.redo();
       if (!redoCheckpoint) {
         ctx.ui.notify('No checkpoint to redo', 'warning');
         return;
       }

       const gitStorage = getGitStorage();
       if (!gitStorage) {
         ctx.ui.notify('Git storage not available', 'error');
         return;
       }

       await gitStorage.restore(redoCheckpoint.gitRef);

       pi.appendEntry('checkpoint-state', checkpointManager.getState());

       // 显示 RevertInfo 组件
       const { RevertInfo } = await import('./components/revert-info.js');

       await ctx.ui.custom<null>((tui, theme, _kb, done) => {
         return new RevertInfo(
           {
             revertedMessages: 1,
             files: redoCheckpoint.files,
             showHint: checkpointManager.canUndo(),  // redo 后可以 undo
             theme,
           },
           tui,
           done
         );
       }, {
         overlay: true,
         overlayOptions: {
           anchor: 'top',
           width: '80%',
           maxHeight: 20,
         }
       });
     } catch (error) {
       ctx.ui.notify(
         `Redo failed: ${error instanceof Error ? error.message : String(error)}`,
         'error'
       );
     }
   }
   ```

3. **测试验证**
   - 执行 `/undo`，验证 RevertInfo 显示
   - 检查文件列表和统计信息
   - 验证 redo 提示显示
   - 按 Escape 关闭组件
   - 执行 `/redo`，验证 RevertInfo 显示

## 依赖任务

- 001: 修复 CheckpointManager undo/redo 命名错误
- 002: 统一 timestamp 单位
- 003: 修复 turn_end 缺少 await

## 阻塞原因

等待任务 001、002、003 完成

## 备注

- RevertInfo 组件提供更好的用户体验
- 集成后可以清楚地看到哪些文件被恢复
- 用户可以选择是否继续 redo 或查看其他内容