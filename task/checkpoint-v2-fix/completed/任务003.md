# 任务003: 修复 turn_end 缺少 await

**状态**: Todo
**优先级**: P0
**预计时间**: 5 分钟

## 任务描述

修复 `index.ts` 中 `turn_end` 事件处理函数缺少 `await` 的问题，确保异步操作正确完成。

## 问题分析

```typescript
// index.ts
pi.on('turn_end', async (event: any, ctx: any) => {
  // ...
  const checkpoint = await gitStorage.createSnapshot(...);  // ✅ await
  checkpointManager.createCheckpoint(...);  // ✅ 同步调用，没问题
  pi.appendEntry('checkpoint-state', checkpointManager.getState());  // ❌ 应该 await
});
```

## 验收标准

- [ ] `pi.appendEntry()` 调用添加 `await`
- [ ] 确保状态持久化完成后再继续
- [ ] 错误处理正确捕获异步错误

## 实施步骤

1. **修复 turn_end 事件处理**
   ```typescript
   // 修改前
   pi.on('turn_end', async (event: any, ctx: any) => {
     if (!fileTracker || !gitStorage || !checkpointManager) return;

     const changes = fileTracker.getChanges();
     if (changes.length === 0) {
       return;
     }

     try {
       const checkpoint = await gitStorage.createSnapshot(
         currentSessionId,
         event.turnIndex,
         changes
       );

       checkpointManager.createCheckpoint(
         event.turnIndex,
         currentSessionId,
         changes,
         checkpoint.gitRef
       );

       // ❌ 缺少 await
       pi.appendEntry('checkpoint-state', checkpointManager.getState());
     } catch (error) {
       console.error('[Checkpoint V2] turn_end - failed to create checkpoint:', error);
       ctx.ui.notify(`Failed to create checkpoint: ${error}`, 'error');
     }
   });

   // 修改后
   pi.on('turn_end', async (event: any, ctx: any) => {
     if (!fileTracker || !gitStorage || !checkpointManager) return;

     const changes = fileTracker.getChanges();
     if (changes.length === 0) {
       return;
     }

     try {
       const checkpoint = await gitStorage.createSnapshot(
         currentSessionId,
         event.turnIndex,
         changes
       );

       checkpointManager.createCheckpoint(
         event.turnIndex,
         currentSessionId,
         changes,
         checkpoint.gitRef
       );

       // ✅ 添加 await
       await pi.appendEntry('checkpoint-state', checkpointManager.getState());
     } catch (error) {
       console.error('[Checkpoint V2] turn_end - failed to create checkpoint:', error);
       ctx.ui.notify(`Failed to create checkpoint: ${error}`, 'error');
     }
   });
   ```

2. **检查其他事件处理函数**
   - 检查 `session_start` 是否需要 await
   - 检查 `session_switch` 是否需要 await
   - 检查 `session_fork` 是否需要 await

3. **测试验证**
   - 执行多次 turn，检查状态是否正确保存
   - 检查 session entries 中是否包含 checkpoint-state

## 依赖任务

无

## 阻塞原因

无

## 备注

- 虽然 `pi.appendEntry()` 可能返回 Promise，但即使不 await 也不会影响功能
- 添加 await 是为了确保状态持久化完成，避免潜在的竞态条件
- 这是一个快速修复，几分钟内可完成