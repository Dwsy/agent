# 任务007: 修复 DiffViewer 键码处理

**状态**: Todo
**优先级**: P1
**预计时间**: 15 分钟

## 问题分析

`DiffViewer` 组件的 `handleInput` 方法使用了错误的键码字符串，应该使用实际的转义序列。

```typescript
// diff-viewer.ts - 错误的键码
switch (data) {
  case 'PAGE_UP':      // ❌ 应该是 '\x1b[5~'
  case 'PAGE_DOWN':    // ❌ 应该是 '\x1b[6~'
  case 'UP':           // ❌ 应该是 '\x1b[A'
  case 'DOWN':         // ❌ 应该是 '\x1b[B'
  case 'HOME':         // ❌ 应该是 '\x1bOH' 或 '\x1b[H'
  case 'END':          // ❌ 应该是 '\x1bOF' 或 '\x1b[F'
  case 'CTRL_U':       // ✅ 正确 '\x15'
  case 'CTRL_D':       // ✅ 正确 '\x04'
  case 'ESCAPE':       // ✅ 正确 '\x1b'
}
```

## 解决方案

有两种修复方案：

### 方案 1：使用 pi-tui 的 `matchesKey` 函数（推荐）

```typescript
import { matchesKey, Key } from '@mariozechner/pi-tui';

// 修改后
handleInput(data: string): void {
  if (matchesKey(data, Key.up)) {
    this.scrollUp(1);
    this.tui.requestRender();
  } else if (matchesKey(data, Key.down)) {
    this.scrollDown(1);
    this.tui.requestRender();
  } else if (matchesKey(data, Key.pageUp)) {
    this.scrollUp(Math.floor(this.visibleLines / 2));
    this.tui.requestRender();
  } else if (matchesKey(data, Key.pageDown)) {
    this.scrollDown(Math.floor(this.visibleLines / 2));
    this.tui.requestRender();
  } else if (matchesKey(data, Key.home)) {
    this.scrollToTop();
    this.tui.requestRender();
  } else if (matchesKey(data, Key.end)) {
    this.scrollToBottom();
    this.tui.requestRender();
  } else if (matchesKey(data, 'ctrl+u')) {
    this.scrollUp(Math.floor(this.visibleLines / 2));
    this.tui.requestRender();
  } else if (matchesKey(data, 'ctrl+d')) {
    this.scrollDown(Math.floor(this.visibleLines / 2));
    this.tui.requestRender();
  } else if (matchesKey(data, Key.escape)) {
    this.onDone();
  }
}
```

### 方案 2：直接使用转义序列

```typescript
// 修改 KEYS 常量定义
const KEYS = {
  ESCAPE: '\x1b',
  UP: '\x1b[A',
  DOWN: '\x1b[B',
  PAGE_UP: '\x1b[5~',
  PAGE_DOWN: '\x1b[6~',
  HOME: '\x1bOH',
  END: '\x1bOF',
  HOME_ALT: '\x1b[H',  // 某些终端
  END_ALT: '\x1b[F',   // 某些终端
  CTRL_U: '\x15',
  CTRL_D: '\x04',
};

// 修改 handleInput
handleInput(data: string): void {
  switch (data) {
    case KEYS.PAGE_UP:
      this.scrollUp(Math.floor(this.visibleLines / 2));
      this.tui.requestRender();
      break;
    case KEYS.PAGE_DOWN:
      this.scrollDown(Math.floor(this.visibleLines / 2));
      this.tui.requestRender();
      break;
    case KEYS.UP:
      this.scrollUp(1);
      this.tui.requestRender();
      break;
    case KEYS.DOWN:
      this.scrollDown(1);
      this.tui.requestRender();
      break;
    case KEYS.HOME:
    case KEYS.HOME_ALT:
      this.scrollToTop();
      this.tui.requestRender();
      break;
    case KEYS.END:
    case KEYS.END_ALT:
      this.scrollToBottom();
      this.tui.requestRender();
      break;
    case KEYS.CTRL_U:
      this.scrollUp(Math.floor(this.visibleLines / 2));
      this.tui.requestRender();
      break;
    case KEYS.CTRL_D:
      this.scrollDown(Math.floor(this.visibleLines / 2));
      this.tui.requestRender();
      break;
    case KEYS.ESCAPE:
      this.onDone();
      break;
  }
}
```

## 验收标准

- [ ] 键盘导航（上下箭头）正常工作
- [ ] Page Up/Down 正常工作
- [ ] Home/End 正常工作
- [ ] Ctrl+U/Ctrl+D 正常工作
- [ ] Escape 退出正常工作
- [ ] 滚动流畅，无卡顿

## 实施步骤

1. 选择修复方案（推荐方案 1）
2. 修改 `diff-viewer.ts` 文件
3. 测试所有键盘快捷键
4. 确认滚动功能正常

## 依赖任务

无

## 备注

- 方案 1 更可靠，因为 `matchesKey` 函数处理了不同终端的差异
- 如果选择方案 2，需要同时处理 HOME/END 的两种变体
- 修复后建议在 tmux 中测试，确保在终端环境中正常工作