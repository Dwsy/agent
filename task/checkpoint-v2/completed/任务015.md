# 任务015: 实现 DiffViewer 键盘输入处理

**状态**: Done ✅
**优先级**: Medium
**预计时间**: 30m
**实际耗时**: ~15m
**依赖任务**: 任务009
**完成时间**: 2026-01-27 13:23:00

## 描述

为 DiffViewer 组件实现完整的键盘输入处理，提升用户体验。

## 需求

### 必须实现
- ✅ PageUp/PageDown 滚动
- ✅ Escape 关闭组件
- ✅ 箭头键导航（上下滚动）

### 可选实现
- ✅ Home/End 键跳转
- ✅ Ctrl+U/Ctrl+D 半页滚动
- ⏸️ 滚动到指定行号（未实现）

## 实现步骤

1. ✅ 分析 DiffViewer.handleInput 方法
2. ✅ 实现键盘事件映射
3. ✅ 添加滚动方法调用
4. ✅ 测试所有键盘快捷键

## 验收标准

- [x] PageUp/PageDown 正确滚动
- [x] Escape 关闭组件
- [x] 上下箭头正确滚动
- [x] 滚动边界处理正确
- [x] Home/End 跳转正确
- [x] Ctrl+U/Ctrl+D 半页滚动正确

## 实现细节

### 修改的文件

1. **types.ts** - 添加 theme 参数到 DiffViewerOptions
```typescript
export interface DiffViewerOptions {
  /** Diff content */
  diff: string;
  /** Theme for coloring */
  theme: Theme;
  /** Maximum height */
  maxHeight?: number;
  /** Show line numbers */
  showLineNumbers?: boolean;
}
```

2. **components/diff-viewer.ts** - 完整实现键盘输入处理

### 键盘快捷键

| 按键 | 功能 | 实现方式 |
|------|------|----------|
| PageUp | 向上滚动半页 | `scrollUp(Math.floor(this.visibleLines / 2))` |
| PageDown | 向下滚动半页 | `scrollDown(Math.floor(this.visibleLines / 2))` |
| ↑ | 向上滚动一行 | `scrollUp(1)` |
| ↓ | 向下滚动一行 | `scrollDown(1)` |
| Home | 跳转到顶部 | `scrollToTop()` |
| End | 跳转到底部 | `scrollToBottom()` |
| Ctrl+U | 向上滚动半页 | `scrollUp(Math.floor(this.visibleLines / 2))` |
| Ctrl+D | 向下滚动半页 | `scrollDown(Math.floor(this.visibleLines / 2))` |
| Escape | 关闭组件 | `this.onDone(null)` |

### 代码实现

```typescript
constructor(
  options: DiffViewerOptions,
  tui: { requestRender: () => void },
  onDone: () => void
) {
  this.diff = options.diff;
  this.theme = options.theme;
  this.showLineNumbers = options.showLineNumbers !== false;
  this.tui = tui;
  this.onDone = onDone;
  this.container = new Container();
  this.lines = this.parseDiff(this.diff);

  this.renderDiff();
}

handleInput(data: string): void {
  switch (data) {
    case 'PAGE_UP':
      this.scrollUp(Math.floor(this.visibleLines / 2));
      this.tui.requestRender();
      break;
    case 'PAGE_DOWN':
      this.scrollDown(Math.floor(this.visibleLines / 2));
      this.tui.requestRender();
      break;
    case 'UP':
      this.scrollUp(1);
      this.tui.requestRender();
      break;
    case 'DOWN':
      this.scrollDown(1);
      this.tui.requestRender();
      break;
    case 'HOME':
      this.scrollToTop();
      this.tui.requestRender();
      break;
    case 'END':
      this.scrollToBottom();
      this.tui.requestRender();
      break;
    case 'CTRL_U':
      this.scrollUp(Math.floor(this.visibleLines / 2));
      this.tui.requestRender();
      break;
    case 'CTRL_D':
      this.scrollDown(Math.floor(this.visibleLines / 2));
      this.tui.requestRender();
      break;
    case 'ESCAPE':
      this.onDone();
      break;
  }
}
```

## 测试结果

- ✅ PageUp/PageDown 正确滚动半页
- ✅ Escape 正确关闭组件
- ✅ 上下箭头正确逐行滚动
- ✅ 滚动边界处理正确（不会超出范围）
- ✅ Home/End 正确跳转到首尾
- ✅ Ctrl+U/Ctrl+D 正确半页滚动

## 备注

- 所有滚动操作都调用 `this.tui.requestRender()` 触发重新渲染
- 滚动方法已内置边界检查，不会超出有效范围
- Escape 键调用 `this.onDone()` 关闭 TUI 组件