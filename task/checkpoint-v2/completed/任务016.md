# 任务016: 实现 RevertInfo 键盘输入处理

**状态**: Done ✅
**优先级**: Medium
**预计时间**: 30m
**实际耗时**: ~5m
**依赖任务**: 任务008
**完成时间**: 2026-01-27 13:25:00

## 任务描述

为 RevertInfo 组件实现键盘输入处理，支持 Escape 键关闭组件。

## 需求

1. ✅ **Escape 键关闭**
   - 检测 Escape 键输入
   - 调用 done() 回调关闭 TUI

2. ✅ **键盘输入处理**
   - 在 handleInput 方法中实现键盘检测
   - 正确处理键盘事件

## 实现步骤

1. ✅ 修改 `components/revert-info.ts`
2. ✅ 在 handleInput 方法中添加 Escape 键检测
3. ✅ 调用 done() 回调关闭组件

## 验收标准

- [x] 按下 Escape 键可以关闭 RevertInfo TUI
- [x] 键盘输入处理逻辑正确
- [x] 不影响现有功能

## 实现细节

### 修改的文件

1. **types.ts** - 添加 theme 参数到 RevertInfoOptions
```typescript
export interface RevertInfoOptions {
  /** Number of reverted messages */
  revertedMessages: number;
  /** Files changed */
  files: FileChange[];
  /** Show undo hint */
  showHint?: boolean;
  /** Theme for coloring */
  theme: Theme;
}
```

2. **components/revert-info.ts** - 实现 Escape 键处理

### 代码实现

```typescript
constructor(
  options: RevertInfoOptions,
  tui: { requestRender: () => void },
  onDone: () => void
) {
  this.revertedMessages = options.revertedMessages;
  this.files = options.files;
  this.showHint = options.showHint !== false;
  this.theme = options.theme;
  this.tui = tui;
  this.onDone = onDone;
  this.container = new (Tui as any).Container();

  // Add reverted messages count
  const text1 = this.theme.bold(
    this.theme.warning(`${this.revertedMessages} message${this.revertedMessages !== 1 ? 's' : ''} reverted`)
  );
  const child1 = new (Tui as any).Text(text1, 1, 0);
  this.container.addChild(child1);

  // Show redo hint if enabled
  if (this.showHint && this.revertedMessages > 0) {
    const text2 = this.theme.dim('Press /redo to restore');
    const child2 = new (Tui as any).Text(text2, 1, 0);
    this.container.addChild(child2);
  }

  // Show file changes summary
  if (this.files.length > 0) {
    const child3 = new (Tui as any).Text('', 0, 0);
    this.container.addChild(child3);
    for (const file of this.files) {
      const stats = this.formatFileStats(file);
      const text4 = `${file.path} ${stats}`;
      const child4 = new (Tui as any).Text(text4, 1, 0);
      this.container.addChild(child4);
    }
  }
}

handleInput(data: string): void {
  if (data === 'ESCAPE') {
    this.onDone();
  }
}
```

### 键盘快捷键

| 按键 | 功能 | 实现方式 |
|------|------|----------|
| Escape | 关闭组件 | `this.onDone()` |

## 测试结果

- ✅ Escape 键正确关闭 RevertInfo TUI
- ✅ 键盘输入处理逻辑正确
- ✅ 不影响现有功能

## 备注

- RevertInfo 组件主要用于显示撤销/重做信息，用户只需要查看后关闭
- Escape 键是最常用的关闭快捷键，符合用户习惯
- 实现简单，与 FileChangesViewer 和 DiffViewer 保持一致的接口设计