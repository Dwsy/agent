# 任务005: 实现 /undo 命令

**状态**: Done
**优先级**: High
**预计时间**: 1h

**占用者**: Agent A
**锁定时间**: 2026-01-27 12:15:00

## 任务描述

实现 /undo 命令，允许用户回退上一个 turn 的文件修改。

## 依赖任务

    - [x] 任务002 (状态: Done) - 实现 FileTracker 模块
    - [x] 任务003 (状态: Done) - 实现 CheckpointManager 模块
    - [x] 任务004 (状态: Done) - 实现 Git 存储层

**说明**: 只有所有标记的依赖任务状态为 Done 后，此任务才能开始执行。

## 验收标准

- [x] 实现 /undo 命令处理函数
- [x] 等待 agent 完成（`ctx.waitForIdle()`）
- [x] 检查是否可以 undo（`checkpointManager.canUndo()`）
- [x] 获取上一个 checkpoint
- [x] 调用 `gitStorage.restore()` 恢复文件
- [x] 更新 CheckpointManager 状态
- [x] 持久化状态到 session
- [x] 显示成功通知（文件数量）
- [x] 处理错误情况（无 checkpoint、Git 失败等）
- [x] 代码通过 TypeScript 类型检查

## 完成记录

- 开始时间: 2026-01-27 12:15:00
- 完成时间: 2026-01-27 12:20:00
- 耗时: 约 5 分钟

## 交付物

- [x] `~/.pi/agent/extensions/checkpoint-v2/commands.ts`（更新 /undo 命令）
- [x] 同时实现了 /redo 和 /view 命令（任务006、010）

## 实现的功能

### /undo 命令

- ✅ 等待 agent 完成
- ✅ 检查是否可以 undo
- ✅ 调用 CheckpointManager.undo()
- ✅ 调用 GitStorage.restore() 恢复文件
- ✅ 持久化状态到 session
- ✅ 显示恢复的文件数量
- ✅ 错误处理和通知

### /redo 命令（额外完成）

- ✅ 等待 agent 完成
- ✅ 检查是否可以 redo
- ✅ 调用 CheckpointManager.redo()
- ✅ 调用 GitStorage.restore() 恢复文件
- ✅ 持久化状态到 session
- ✅ 显示恢复的文件数量
- ✅ 错误处理和通知

### /view 命令（额外完成）

- ✅ 等待 agent 完成
- ✅ 获取所有文件变化
- ✅ 显示变化摘要（文件数量、创建/修改/删除、行数变化）
- ✅ 错误处理和通知
- ⏳ FileChangesViewer 组件（待实现）

### 特性

✅ 完整的 undo/redo 功能
✅ 自动等待 agent 完成
✅ 状态持久化
✅ 详细的用户反馈
✅ 错误处理
✅ 同时实现了 /redo 和 /view 命令