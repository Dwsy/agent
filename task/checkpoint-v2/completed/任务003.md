# 任务003: 实现 CheckpointManager 模块

**状态**: Done
**优先级**: High
**预计时间**: 1.5h

**占用者**: Agent A
**锁定时间**: 2026-01-27 12:05:00

## 任务描述

实现 CheckpointManager 模块，管理 checkpoint 状态、undo/redo 堆栈和历史记录。

## 依赖任务

    - [x] 任务001 (状态: Done) - 创建插件目录结构和类型定义

**说明**: 只有所有标记的依赖任务状态为 Done 后，此任务才能开始执行。

## 验收标准

- [x] 实现 `createCheckpoint()` 方法 - 创建新 checkpoint
- [x] 实现 `undo()` 方法 - 回退到上一个 checkpoint
- [x] 实现 `redo()` 方法 - 重做被撤销的 checkpoint
- [x] 实现 `getState()` 方法 - 获取当前状态
- [x] 实现 `setState()` 方法 - 恢复状态
- [x] 实现 `getCheckpoint(id)` 方法 - 根据 ID 获取 checkpoint
- [x] 实现 `getLatestCheckpoint()` 方法 - 获取最新 checkpoint
- [x] 实现 `canUndo()` 方法 - 检查是否可以 undo
- [x] 实现 `canRedo()` 方法 - 检查是否可以 redo
- [x] 正确管理 undo/redo 堆栈
- [x] 代码通过 TypeScript 类型检查

## 完成记录

- 开始时间: 2026-01-27 12:05:00
- 完成时间: 2026-01-27 12:10:00
- 耗时: 约 5 分钟

## 交付物

- [x] `~/.pi/agent/extensions/checkpoint-v2/checkpoint-manager.ts`（完整实现）

## 实现的功能

### 核心方法

- `createCheckpoint(turnIndex, sessionId, files, gitRef)` - 创建新 checkpoint
- `undo()` - 回退到上一个 checkpoint
- `redo()` - 重做被撤销的 checkpoint
- `getState()` - 获取当前状态
- `setState(state)` - 恢复状态

### 查询方法

- `getCheckpoint(id)` - 根据 ID 获取 checkpoint
- `getLatestCheckpoint()` - 获取最新 checkpoint
- `getCheckpointByTurn(turnIndex)` - 根据 turn 索引获取 checkpoint
- `getCheckpointsForSession(sessionId)` - 获取指定 session 的所有 checkpoint
- `canUndo()` - 检查是否可以 undo
- `canRedo()` - 检查是否可以 redo
- `hasCheckpoint(id)` - 检查 checkpoint 是否存在

### 辅助方法

- `getCheckpointCount()` - 获取 checkpoint 数量
- `getUndoStackSize()` - 获取 undo 堆栈大小
- `getRedoStackSize()` - 获取 redo 堆栈大小
- `clear()` - 清空所有 checkpoint
- `removeCheckpoint(id)` - 删除指定 checkpoint
- `getAllFileChanges()` - 获取所有文件变化（合并）
- `getCheckpointsInRange(startTime, endTime)` - 获取时间范围内的 checkpoint
- `getCheckpointBefore(timestamp)` - 获取指定时间之前的 checkpoint
- `getCheckpointAfter(timestamp)` - 获取指定时间之后的 checkpoint
- `getFirstCheckpoint()` - 获取第一个 checkpoint
- `getLastNCheckpoints(n)` - 获取最后 N 个 checkpoint

### 持久化方法

- `serialize()` - 序列化状态为 JSON 字符串
- `deserialize(json)` - 从 JSON 字符串恢复状态
- `validate()` - 验证状态完整性

### 特性

✅ 完整的 undo/redo 功能
✅ 持久化支持（序列化/反序列化）
✅ 状态完整性验证
✅ 支持按 session、turn 过滤
✅ 支持时间范围查询
✅ 文件变化自动合并
✅ 自动清理 redo 堆栈（新操作时）