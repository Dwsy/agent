# 任务004: 实现 Git 存储层

**状态**: Done
**优先级**: High
**预计时间**: 2h

**占用者**: Agent A
**锁定时间**: 2026-01-27 11:55:00

## 任务描述

实现 Git 存储层模块，使用独立的 `~/.pt/git` 目录存储 checkpoint，不影响用户主项目的 `.git` 目录。

## 依赖任务

    - [x] 任务001 (状态: Done) - 创建插件目录结构和类型定义

**说明**: 只有所有标记的依赖任务状态为 Done 后，此任务才能开始执行。

## 验收标准

- [x] 实现 `initialize()` 方法 - 初始化 Git 仓库
- [x] 实现 `createSnapshot(files)` 方法 - 创建 checkpoint
- [x] 实现 `restore(gitRef)` 方法 - 恢复文件
- [x] 实现 `loadCheckpoint(refName)` 方法 - 加载 checkpoint 数据
- [x] 实现 `listCheckpoints()` 方法 - 列出所有 checkpoint
- [x] 实现 `deleteCheckpoint(refName)` 方法 - 删除 checkpoint
- [x] 使用 `~/.pt/git` 作为独立 Git 目录
- [x] 使用 `git --git-dir=~/.pt/git --work-tree=<project>` 命令
- [x] Checkpoint 存储为 Git refs: `refs/checkpoints/<id>`
- [x] 代码通过 TypeScript 类型检查

## 完成记录

- 开始时间: 2026-01-27 11:55:00
- 完成时间: 2026-01-27 12:00:00
- 耗时: 约 5 分钟

## 交付物

- [x] `~/.pi/agent/extensions/checkpoint-v2/git-storage.ts`（完整实现）

## 实现的功能

### 核心方法

- `initialize()` - 初始化 `~/.pt/git` 仓库
- `createSnapshot(sessionId, turnIndex, files)` - 创建 checkpoint
- `restore(gitRef)` - 恢复文件到 checkpoint 状态
- `loadCheckpoint(refName)` - 加载 checkpoint 数据
- `listCheckpoints(sessionId?)` - 列出所有或指定 session 的 checkpoint
- `deleteCheckpoint(refName)` - 删除 checkpoint

### 辅助方法

- `getLatestCheckpoint(sessionId)` - 获取最新的 checkpoint
- `getCheckpointById(id)` - 根据 ID 获取 checkpoint
- `cleanupOldCheckpoints(days)` - 清理旧的 checkpoint（默认30天）

### 特性

✅ 使用独立的 `~/.pt/git` 目录
✅ 不影响用户主项目的 `.git` 目录
✅ Checkpoint 存储为 Git refs
✅ Metadata 存储在 commit message 中
✅ 支持按 session 过滤 checkpoint
✅ 自动清理旧的 checkpoint
