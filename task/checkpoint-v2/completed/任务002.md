# 任务002: 实现 FileTracker 模块

**状态**: Done
**优先级**: High
**预计时间**: 1h

**占用者**: Agent A
**锁定时间**: 2026-01-27 11:45:00

## 任务描述

实现 FileTracker 模块，用于跟踪单个 turn 内的文件修改（edit/write 工具调用）。

## 依赖任务

    - [x] 任务001 (状态: Done) - 创建插件目录结构和类型定义

**说明**: 只有所有标记的依赖任务状态为 Done 后，此任务才能开始执行。

## 验收标准

- [x] 实现 `trackFile(path, action)` 方法
- [x] 实现 `getChanges()` 方法
- [x] 实现 `clear()` 方法
- [x] 实现 `hasChanges()` 方法
- [x] 正确处理重复文件路径（合并变化）
- [x] 忽略被忽略的目录和文件
- [x] 代码通过 TypeScript 类型检查

## 实施步骤

### 步骤 1: 更新 FileTracker 类 ✅

实现以下方法：

```typescript
export class FileTracker {
  private changes = new Map<string, FileChange>();
  private repoRoot: string = '';

  trackFile(path: string, action: FileAction): void {
    // 1. 检查是否应该忽略
    // 2. 更新或添加文件变化
  }

  getChanges(): FileChange[] {
    // 返回所有变化
  }

  clear(): void {
    // 清空所有变化
  }

  hasChanges(): boolean {
    // 检查是否有变化
  }
}
```

### 步骤 2: 实现忽略逻辑 ✅

使用 `shouldIgnorePath()` 和 `isInIgnoredDir()` 检查文件是否应该被忽略。

### 步骤 3: 实现文件变化合并 ✅

如果同一文件被多次修改，合并其 additions/deletions。

### 步骤 4: 实现文件动作检测 ✅

根据文件是否存在判断是 created、modified 还是 deleted。

### 步骤 5: 类型检查 ✅

```bash
cd ~/.pi/agent/extensions/checkpoint-v2
npx tsc --noEmit
```

## 技术细节

### 文件动作判断规则

- `created`: 文件之前不存在，现在存在
- `modified`: 文件之前存在，现在也存在
- `deleted`: 文件之前存在，现在不存在

### 忽略规则

使用 `utils.ts` 中的：
- `shouldIgnorePath()` - 检查目录名和扩展名
- `isInIgnoredDir()` - 检查是否在忽略目录内
- `IGNORED_DIRS` - 忽略的目录列表
- `IGNORED_EXTENSIONS` - 忽略的扩展名列表

### 数据结构

使用 `Map<string, FileChange>` 存储文件变化，key 为文件路径，便于快速查找和合并。

## 阻塞原因

**如果状态为 Blocked，在此记录阻塞原因**：
- 无

## 并行提示

- 依赖任务001已完成，可立即开始
- 完成后可解锁任务005（/undo 命令）、任务011（集成事件监听）

## 备注

- 文件路径应该相对于仓库根目录
- 使用 `fs.existsSync()` 检查文件是否存在
- 考虑文件可能被多次修改的情况

## 完成记录

- 开始时间: 2026-01-27 11:45:00
- 完成时间: 2026-01-27 11:50:00
- 耗时: 约 5 分钟

## 交付物

- [x] `~/.pi/agent/extensions/checkpoint-v2/file-tracker.ts`（完整实现）

## 实现的功能

### 核心方法

- `trackFile(path, action)` - 跟踪文件修改，自动忽略和合并
- `getChanges()` - 获取所有跟踪的文件变化
- `clear()` - 清空所有跟踪的变化
- `hasChanges()` - 检查是否有变化
- `hasFile(path)` - 检查是否跟踪了特定文件
- `getFileChange(path)` - 获取特定文件的变化

### 辅助方法

- `setRepoRoot(root)` - 设置仓库根目录（用于路径归一化）
- `detectFileAction(path)` - 根据文件存在性自动检测动作类型
- `updateFileStats(path, additions, deletions)` - 更新文件统计（行数变化）
- `getSummary()` - 获取变化摘要（文件数量、动作分类、行数统计）

### 特性

✅ 自动忽略指定目录（node_modules, .venv, dist 等）
✅ 自动忽略指定文件扩展名（.log, .tmp 等）
✅ 路径归一化（相对路径，统一使用 /）
✅ 文件动作合并（deleted 优先，created 次之）
✅ 文件统计合并（additions/deletions）