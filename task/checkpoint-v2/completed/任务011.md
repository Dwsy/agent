# 任务011: 集成事件监听

**状态**: Done
**优先级**: High
**预计时间**: 1h

**占用者**: Agent A
**锁定时间**: 2026-01-27 12:25:00

## 任务描述

集成事件监听，让插件在正确的时机创建 checkpoint 和跟踪文件变化。

## 依赖任务

    - [x] 任务002 (状态: Done) - 实现 FileTracker 模块
    - [x] 任务004 (状态: Done) - 实现 Git 存储层

**说明**: 只有所有标记的依赖任务状态为 Done 后，此任务才能开始执行。

## 验收标准

- [x] 在 turn_start 时清空 fileTracker
- [x] 在 tool_result 时跟踪 edit/write 操作
- [x] 在 turn_end 时创建 checkpoint
- [x] 正确检测文件动作
- [x] 使用 gitStorage.createSnapshot() 创建 checkpoint
- [x] 持久化状态到 session
- [x] 设置 repoRoot 用于路径归一化
- [x] 代码通过 TypeScript 类型检查

## 完成记录

- 开始时间: 2026-2026-01-27 12:25:00
- 完成时间: 2026-01-27 12:30:00
- 耗时: 约 5 分钟

## 交付物

- [x] `~/.pi/agent/extensions/checkpoint-v2/index.ts`（更新事件监听）

## 实现的功能

### turn_start 事件

- ✅ 清空 fileTracker
- ✅ 设置 repoRoot（用于路径归一化）

### turn_end 事件

- ✅ 获取文件变化
- ✅ 跳过无变化的情况（不创建 checkpoint）
- ✅ 调用 gitStorage.createSnapshot() 创建 checkpoint
- ✅ 调用 checkpointManager.createCheckpoint() 添加到历史
- ✅ 持久化状态到 session
- ✅ 错误处理和通知

### tool_result 事件

- ✅ 监听 edit/write 工具
- ✅ 检测文件动作（created/modified/deleted）
- ✅ 跟踪文件变化

### 特性

✅ 自动检测文件动作
✅ 只在有变化时创建 checkpoint
✅ 完整的错误处理
✅ 状态持久化
✅ 路径归一化

## 事件流程

```
turn_start
    ↓
fileTracker.clear()
fileTracker.setRepoRoot(ctx.cwd)
    ↓
tool_result (edit/write)
    ↓
fileTracker.detectFileAction(path)
fileTracker.trackFile(path, action)
    ↓
turn_end
    ↓
fileTracker.getChanges()
gitStorage.createSnapshot()
checkpointManager.createCheckpoint()
pi.appendEntry('checkpoint-state')
```