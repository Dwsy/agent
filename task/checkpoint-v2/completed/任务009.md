# 任务009: 实现 DiffViewer 组件

**状态**: Done
**优先级**: High
**预计时间**: 1.5h

**占用者**: Agent A
**锁定时间**: 2026-01-27 12:55:00

## 任务描述

实现 DiffViewer 组件，显示文件差异（diff）。

## 依赖任务

    - [x] 任务001 (状态: Done) - 创建插件目录结构和类型定义

**说明**: 只有所有标记的依赖任务状态为 Done 后，此任务才能开始执行。

## 验收标准

- [x] 使用 pi-tui 的 Container 和 Text 组件
- [x] 显示添加的行（绿色，+）
- [x] 显示删除的行（红色，-）
- [x] 显示未改动的行（灰色）
- [x] 显示行号
- [x] 支持滚动（scrollTo, scrollUp, scrollDown）
- [x] 使用主题颜色（success/error/muted/accent）
- [x] 代码通过 TypeScript 类型检查

## 完成记录

- 开始时间: 2026-01-27 12:55:00
- 完成时间: 2026-01-27 13:00:00
- 耗时: 约 5 分钟

## 交付物

- [x] `~/.pi/agent/extensions/checkpoint-v2/components/diff-viewer.ts`（完整实现）
- [x] `~/.pi/agent/extensions/checkpoint-v2/components/revert-info.ts`（已修复）
- [x] TypeScript 类型检查通过

## 实现的功能

### 核心方法

- `render(width)` - 渲染组件
- `handleInput(data)` - 处理键盘输入
- `invalidate()` - 清除缓存

### Diff 处理方法

- `parseDiff(diff)` - 解析 diff 字符串为结构化行
- `renderDiff()` - 渲染 diff 到容器
- `formatLine(line)` - 格式化单行（带行号）
- `formatContent(line)` - 格式化行内容（带颜色）

### 滚动方法

- `scrollTo(position)` - 滚动到指定位置
- `scrollUp(lines)` - 向上滚动
- `scrollDown(lines)` - 向下滚动
- `scrollToTop()` - 滚动到顶部
- `scrollToBottom()` - 滚动到底部

### 辅助方法

- `getLineCount()` - 获取总行数
- `getVisibleRange()` - 获取可见范围
- `getSummary()` - 获取 diff 摘要
- `padLeft(str, width)` - 左填充字符串

### 特性

✅ 使用 pi-tui 的 Container 和 Text 组件
✅ 解析 unified diff 格式
✅ 显示添加行（绿色）
✅ 显示删除行（红色）
✅ 显示上下文行（灰色）
✅ 显示 hunk 头部（accent）
✅ 支持行号显示
✅ 支持滚动导航
✅ 适配主题颜色
✅ TypeScript 类型检查通过

### Diff 格式支持

```
@@ -1,5 +1,7 @@
 line 1
-line 2
+line 2 modified
 line 3
+line 4 added
 line 5
```

## 备注

- 使用 pi-tui 的 Container 和 Text 组件
- 需要访问 Theme 实例
- 组件通过 `ctx.ui.custom()` 显示
- Diff 来自 GitStorage.getFileDiff()
- 支持滚动查看长 diff
- 适合在 /view 命令中显示选中文件的差异