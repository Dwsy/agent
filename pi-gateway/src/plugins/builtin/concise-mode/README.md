# Concise-Mode Plugin

ç®€æ´è¾“å‡ºæ¨¡å¼æ’ä»¶ï¼Œç”¨äºæŠ‘åˆ¶å†—ä½™çš„è‡ªåŠ¨å›å¤å’Œæµå¼è¾“å‡ºã€‚

## æ¶æ„è®¾è®¡

### é—®é¢˜èƒŒæ™¯

Telegram æ’ä»¶çš„æµå¼è¾“å‡ºç›´æ¥è°ƒç”¨ `runtime.api.dispatch()`ï¼Œç»•è¿‡äº† gateway çš„ `message_received` hookï¼Œå¯¼è‡´ï¼š
1. Prompt æ— æ³•æ³¨å…¥
2. æµå¼è¾“å‡ºæ— æ³•ç¦ç”¨
3. å·¥å…·è°ƒç”¨ hook æ— æ³•è§¦å‘

### è§£å†³æ–¹æ¡ˆ

**åŒå±‚æŠ‘åˆ¶æ¶æ„ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Telegram streaming.ts (æµå¼è¾“å‡ºæ§åˆ¶)                â”‚
â”‚ - æ£€æµ‹ concise-mode é…ç½®                                     â”‚
â”‚ - ç›´æ¥æ³¨å…¥ prompt                                            â”‚
â”‚ - ç¦ç”¨ streamMode                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: Gateway message-send.ts (å·¥å…·è°ƒç”¨æŠ‘åˆ¶)              â”‚
â”‚ - before_tool_call: å…è®¸ä¿®æ”¹/æ¸…é™¤ text                       â”‚
â”‚ - after_tool_call: è®°å½•çŠ¶æ€ä¾› message_sending ä½¿ç”¨           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: Gateway message-pipeline.ts (æœ€ç»ˆå›å¤æŠ‘åˆ¶)          â”‚
â”‚ - message_sending: æ£€æŸ¥ suppressRoutesï¼Œæ›¿æ¢ä¸º [NO_REPLY]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è®¾è®¡ç›®æ ‡

**ç®€æ´æ¨¡å¼ â‰  åªå›å¤ä¸€æ¬¡**

ç®€æ´æ¨¡å¼çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š

1. âœ… **æŠ‘åˆ¶è‡ªåŠ¨å›å¤** - Agent æ‰§è¡Œå®Œæˆåä¸è¦è‡ªåŠ¨å›å¤
2. âœ… **æ”¯æŒä¸»åŠ¨æ¶ˆæ¯** - AI å¯ä»¥é€šè¿‡ `send_message` å·¥å…·å‘é€å¤šæ¡æ¶ˆæ¯
3. âœ… **ç¦ç”¨æµå¼è¾“å‡º** - ä¸å®æ—¶æ¨é€æ€è€ƒå’Œå·¥å…·è°ƒç”¨
4. âœ… **ä¿æŒå¯¹è¯èƒ½åŠ›** - ç”¨æˆ·ç»§ç»­å‘æ¶ˆæ¯ï¼ŒAI ä»èƒ½å›å¤

**ç¤ºä¾‹åœºæ™¯ï¼š**

```
ç”¨æˆ·ï¼šå¸®æˆ‘æ£€æŸ¥ç³»ç»ŸçŠ¶æ€

AI: [é€šè¿‡ send_message å‘é€]
âœ… CPU: 45%
âœ… Memory: 2.3GB/8GB
âœ… Disk: 45% used

[æ— è‡ªåŠ¨å›å¤ "è¿˜æœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿ"]

ç”¨æˆ·ï¼šå¥½çš„è°¢è°¢
AI: [æ­£å¸¸å›å¤] ä¸å®¢æ°”ï¼
```

```jsonc
{
  "plugins": {
    "config": {
      "concise-mode": {
        "enabled": true,
        "channels": ["telegram"]
      }
    }
  }
}
```

## å·¥ä½œæµç¨‹

### æ¶ˆæ¯æ¥æ”¶è·¯å¾„

```
ç”¨æˆ·æ¶ˆæ¯ â†’ Telegram handlers.ts
         â†’ dispatchAgentTurn()
         â†’ æ³¨å…¥ CONCISE_PROMPT âœ…
         â†’ ç¦ç”¨ streamMode âœ…
         â†’ runtime.api.dispatch(textWithPrompt)
         â†’ Gateway dispatchMessage()
         â†’ message_received hook (å†—ä½™ä½†æ— å®³)
         â†’ processMessage()
         â†’ Agent æ‰§è¡Œ
```

### å·¥å…·è°ƒç”¨è·¯å¾„

```
Agent è°ƒç”¨ send_message
    â†’ POST /api/message/send
    â†’ before_tool_call hook âœ…
    â†’ concise-mode æ¸…é™¤ text (å¦‚éœ€è¦)
    â†’ channelPlugin.outbound.sendText()
    â†’ after_tool_call hook âœ…
    â†’ æ·»åŠ  suppress route
```

### æœ€ç»ˆå›å¤è·¯å¾„

```
Agent æ‰§è¡Œå®Œæˆ
    â†’ message-pipeline.ts
    â†’ message_sending hook
    â†’ æ£€æŸ¥ suppressRoutes
    â†’ æ›¿æ¢ä¸º [NO_REPLY] âœ…
    â†’ respond() è¢«è·³è¿‡
```

## å…³é”®è®¾è®¡å†³ç­–

### ä¸ºä»€ä¹ˆåœ¨ streaming.ts ç›´æ¥æ³¨å…¥ promptï¼Ÿ

å› ä¸º `message_received` hook åœ¨ gateway å±‚è§¦å‘ï¼Œä½† `dispatchAgentTurn` ç›´æ¥è°ƒç”¨ `runtime.api.dispatch()`ï¼Œç»•è¿‡äº† hook ç³»ç»Ÿã€‚

### ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚æŠ‘åˆ¶ï¼Ÿ

1. **Layer 1**ï¼šé˜²æ­¢æµå¼è¾“å‡ºï¼ˆæ€è€ƒğŸ’­ã€å·¥å…·è°ƒç”¨å®æ—¶æ¨é€ï¼‰
2. **Layer 2**ï¼šå…è®¸ hook ä¿®æ”¹ send_message å‚æ•°
3. **Layer 3**ï¼šæŠ‘åˆ¶ gateway çš„è‡ªåŠ¨å›å¤

### ä¸ºä»€ä¹ˆ `isConciseMode = true` ç¡¬ç¼–ç ï¼Ÿ

å› ä¸º concise-mode æ’ä»¶å¯ç”¨æ—¶ï¼Œæ‰€æœ‰ Telegram æ¶ˆæ¯éƒ½åº”è¯¥ä½¿ç”¨ç®€æ´æ¨¡å¼ã€‚æœªæ¥å¯ä»¥é€šè¿‡é…ç½®æ”¯æŒ per-session åˆ‡æ¢ã€‚

## æµ‹è¯•åœºæ™¯

- âœ… å•æ¶ˆæ¯åœºæ™¯ï¼šåªå‘é€ä¸€æ¬¡ï¼Œæ— è‡ªåŠ¨å›å¤
- âœ… å¤šæ¶ˆæ¯åœºæ™¯ï¼šæ¯æ¬¡ send_message åæŠ‘åˆ¶è‡ªåŠ¨å›å¤
- âœ… æµå¼è¾“å‡ºï¼šç¦ç”¨ï¼Œä¸æ˜¾ç¤ºæ€è€ƒå’Œå·¥å…·è°ƒç”¨
- âœ… é”™è¯¯å¤„ç†ï¼šsend_message å¤±è´¥æ—¶ä¸æŠ‘åˆ¶
- âœ… é€šé“éš”ç¦»ï¼šä»…é…ç½®çš„é€šé“å¯ç”¨ç®€æ´æ¨¡å¼

## æ‰©å±•æ–¹å‘

1. **Per-session åˆ‡æ¢**ï¼šæ”¯æŒ `/concise on|off` å‘½ä»¤
2. **æ™ºèƒ½æŠ‘åˆ¶**ï¼šæ ¹æ®æ¶ˆæ¯ç±»å‹å†³å®šæ˜¯å¦æŠ‘åˆ¶
3. **æŒ‡æ ‡è¿½è¸ª**ï¼šè®°å½•æŠ‘åˆ¶æ¬¡æ•°ã€èŠ‚çœ token æ•°
