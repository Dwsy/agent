# Concise-Mode Architecture

## è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)

æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„èŒè´£ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  concise-mode/                                               â”‚
â”‚  â”œâ”€â”€ index.ts              â† æ’ä»¶ç¼–æ’ï¼ˆOrchestratorï¼‰        â”‚
â”‚  â”œâ”€â”€ core/                                                 â”‚
â”‚  â”‚   â”œâ”€â”€ state-manager.ts  â† çŠ¶æ€ç®¡ç†ï¼ˆState Patternï¼‰     â”‚
â”‚  â”‚   â”œâ”€â”€ prompt-injector.ts â† ç­–ç•¥æ³¨å…¥ï¼ˆStrategy Patternï¼‰ â”‚
â”‚  â”‚   â””â”€â”€ index.ts          â† æ¨¡å—å¯¼å‡º                      â”‚
â”‚  â”œâ”€â”€ README.md             â† ä½¿ç”¨è¯´æ˜                       â”‚
â”‚  â””â”€â”€ ARCHITECTURE.md       â† æ¶æ„æ–‡æ¡£                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. çŠ¶æ€æ¨¡å¼ (State Pattern)

`ConciseStateManager` å°è£…ä¼šè¯çŠ¶æ€å’ŒçŠ¶æ€è½¬æ¢ï¼š

```typescript
class ConciseStateManager {
  // çŠ¶æ€ï¼šæ´»è·ƒä¼šè¯
  private activeSessions: Map<string, ConciseSessionState>;
  
  // çŠ¶æ€ï¼šæŠ‘åˆ¶è·¯ç”±ï¼ˆå¸¦ TTLï¼‰
  private suppressRoutes: Map<string, number>;
  
  // çŠ¶æ€è½¬æ¢æ–¹æ³•
  activateSession(): void;
  addSuppressRoute(): boolean;
  shouldSuppress(): boolean;
  cleanup(): number;
}
```

**ä¼˜åŠ¿ï¼š**
- çŠ¶æ€é€»è¾‘é›†ä¸­ç®¡ç†
- æ˜“äºæ·»åŠ æ–°çŠ¶æ€ï¼ˆå¦‚ï¼šå†·å´æœŸã€é™æµï¼‰
- æ”¯æŒæŒ‡æ ‡è¿½è¸ªå’Œè¯Šæ–­

### 3. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

`InjectionStrategy` å°è£…æç¤ºè¯æ³¨å…¥ç­–ç•¥ï¼š

```typescript
interface InjectionStrategy {
  inject(text: string, context?: InjectionContext): string;
  getMarker(): string;
}

// å…·ä½“ç­–ç•¥
class SuffixInjectionStrategy { ... }
class SystemPromptInjectionStrategy { ... }

// å·¥å‚
class InjectionStrategyFactory {
  static create(channel: string): InjectionStrategy;
}
```

**ä¼˜åŠ¿ï¼š**
- æ˜“äºæ‰©å±•æ–°ç­–ç•¥ï¼ˆå¦‚ï¼šPrefixã€Template-basedï¼‰
- æ”¯æŒæŒ‰é€šé“/åœºæ™¯é€‰æ‹©ç­–ç•¥
- ç­–ç•¥å¯ç‹¬ç«‹æµ‹è¯•

### 4. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

é€šè¿‡ Gateway Hook ç³»ç»Ÿå®ç°äº‹ä»¶é©±åŠ¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Plugin Hooks    â”‚â”€â”€â”€â”€â–¶â”‚  Concise Mode    â”‚
â”‚  - message_received     â”‚  - stateManager  â”‚
â”‚  - before_tool_call     â”‚  - injector      â”‚
â”‚  - after_tool_call      â”‚                  â”‚
â”‚  - message_sending      â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿ï¼š**
- æ¾è€¦åˆæ¶æ„
- æ’ä»¶å¯ç‹¬ç«‹å¼€å‘/æµ‹è¯•
- æ”¯æŒåŠ¨æ€å¯ç”¨/ç¦ç”¨

### 5. ä¾èµ–æ³¨å…¥ (Dependency Injection)

é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼š

```typescript
class ConciseModeHandler {
  constructor(
    private runtime: TelegramPluginRuntime,
    private account: TelegramAccountRuntime,
    private enabled: boolean = true
  ) {}
}
```

**ä¼˜åŠ¿ï¼š**
- æ˜“äºå•å…ƒæµ‹è¯•ï¼ˆå¯æ³¨å…¥ mockï¼‰
- é…ç½®ä¸å®ç°åˆ†ç¦»
- æ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢ç­–ç•¥

---

## æ•°æ®æµ

### æ¶ˆæ¯æ¥æ”¶è·¯å¾„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram ç”¨æˆ·å‘é€æ¶ˆæ¯                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handlers.ts: processMessage()                                â”‚
â”‚ - è§£ææ¶ˆæ¯å†…å®¹                                               â”‚
â”‚ - è°ƒç”¨ dispatchAgentTurn()                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ streaming.ts: dispatchAgentTurn()                            â”‚
â”‚ - ConciseModeHandler.injectPrompt() âœ…                       â”‚
â”‚ - ConciseModeHandler.resolveStreamConfig() âœ…                â”‚
â”‚ - runtime.api.dispatch(textWithPrompt)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gateway: dispatchMessage()                                   â”‚
â”‚ - message_received hook (å†—ä½™ä½†æ— å®³)                         â”‚
â”‚ - processMessage() â†’ Agent æ‰§è¡Œ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥å…·è°ƒç”¨è·¯å¾„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent è°ƒç”¨ send_message å·¥å…·                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ gateway-tools/send-message.ts                                â”‚
â”‚ - POST /api/message/send                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ message-send.ts: handleMessageSendRequest()                  â”‚
â”‚ - ToolCallInterceptor.beforeCall() âœ…                        â”‚
â”‚   â†’ before_tool_call hook                                    â”‚
â”‚   â†’ concise-mode å¯ä¿®æ”¹ args                                 â”‚
â”‚ - channelPlugin.outbound.sendText()                          â”‚
â”‚ - ToolCallInterceptor.afterCall() âœ…                         â”‚
â”‚   â†’ after_tool_call hook                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConciseStateManager.addSuppressRoute()                       â”‚
â”‚ - æ·»åŠ æŠ‘åˆ¶è·¯ç”±ï¼ˆå¸¦ TTLï¼‰                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœ€ç»ˆå›å¤è·¯å¾„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent æ‰§è¡Œå®Œæˆ                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ message-pipeline.ts: processMessage()                        â”‚
â”‚ - message_sending hook                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConciseStateManager.shouldSuppress()                         â”‚
â”‚ - æ£€æŸ¥æŠ‘åˆ¶è·¯ç”±                                               â”‚
â”‚ - éªŒè¯ TTL                                                   â”‚
â”‚ - è¿”å› true/false                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚
          â–¼                     â–¼
     âœ… åº”è¯¥æŠ‘åˆ¶            âŒ ä¸åº”è¯¥æŠ‘åˆ¶
          â”‚                     â”‚
          â–¼                     â–¼
   message.text =        æ­£å¸¸å‘é€
   [NO_REPLY]
```

---

## å…³é”®è®¾è®¡å†³ç­–

### ä¸ºä»€ä¹ˆåœ¨ streaming.ts ç›´æ¥æ³¨å…¥ promptï¼Ÿ

**é—®é¢˜ï¼š** `message_received` hook åœ¨ gateway å±‚è§¦å‘ï¼Œä½† Telegram çš„ `dispatchAgentTurn` ç›´æ¥è°ƒç”¨ `runtime.api.dispatch()`ï¼Œç»•è¿‡äº† hook ç³»ç»Ÿã€‚

**è§£å†³æ–¹æ¡ˆï¼š** åœ¨ streaming.ts ä¸­ç›´æ¥æ³¨å…¥ï¼Œç¡®ä¿ prompt ä¸€å®šè¢«æ·»åŠ ã€‚

**æƒè¡¡ï¼š**
- âœ… å¯é æ€§é«˜ï¼Œä¸ä¾èµ–å¤–éƒ¨ hook
- âŒ ä¸ gateway çš„ hook æœ‰å†—ä½™ï¼ˆä½†æ— å®³ï¼‰
- ğŸ“ æœªæ¥å¯è€ƒè™‘ç»Ÿä¸€æ³¨å…¥ç‚¹

### ä¸ºä»€ä¹ˆä½¿ç”¨ TTL æœºåˆ¶ï¼Ÿ

**é—®é¢˜ï¼š** å¦‚æœ `message_sending` hook å¤±è´¥æˆ–ä»æœªè§¦å‘ï¼Œsuppress route ä¼šæ°¸è¿œå­˜åœ¨ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** ä¸ºæ¯ä¸ª route è®¾ç½® 5 ç§’ TTLï¼Œè¶…æ—¶è‡ªåŠ¨æ¸…ç†ã€‚

**æƒè¡¡ï¼š**
- âœ… é˜²æ­¢å†…å­˜æ³„æ¼
- âœ… è‡ªåŠ¨æ¢å¤å¼‚å¸¸çŠ¶æ€
- ğŸ“ éœ€è¦å®šæœŸ cleanupï¼ˆ30 ç§’ä¸€æ¬¡ï¼‰

### ä¸ºä»€ä¹ˆ `isConciseMode = true` ç¡¬ç¼–ç ï¼Ÿ

**å½“å‰è®¾è®¡ï¼š** Telegram é€šé“å¯ç”¨ concise-mode æ’ä»¶æ—¶ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½ä½¿ç”¨ç®€æ´æ¨¡å¼ã€‚

**æœªæ¥æ‰©å±•ï¼š**
```typescript
// æ”¯æŒ per-session åˆ‡æ¢
const isConciseMode = sessionConfig.conciseMode ?? true;

// æ”¯æŒå‘½ä»¤åˆ‡æ¢
if (text === "/concise on") {
  sessionConfig.conciseMode = true;
}
```

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```typescript
// State Manager æµ‹è¯•
describe("ConciseStateManager", () => {
  test("should activate session for enabled channel");
  test("should add suppress route successfully");
  test("should suppress route before expiry");
  test("should cleanup expired routes");
  test("should track metrics");
});

// Prompt Injector æµ‹è¯•
describe("InjectionStrategy", () => {
  test("should inject prompt suffix");
  test("should detect concise-mode marker");
});
```

### é›†æˆæµ‹è¯•

```typescript
// Full flow test
test("end-to-end: message â†’ prompt inject â†’ suppress reply", async () => {
  // 1. Send message
  // 2. Verify prompt injected
  // 3. Agent calls send_message
  // 4. Verify auto-reply suppressed
});
```

---

## æ€§èƒ½æŒ‡æ ‡

### å†…å­˜å ç”¨

- `activeSessions`: ~100 bytes/session
- `suppressRoutes`: ~50 bytes/route
- å…¸å‹åœºæ™¯ï¼š< 10KB

### CPU å¼€é”€

- Hook å¤„ç†ï¼š< 1ms/hook
- Cleanup: < 0.1ms/30s
- å¯å¿½ç•¥ä¸è®¡

### å»¶è¿Ÿå½±å“

- Prompt æ³¨å…¥ï¼š0msï¼ˆå­—ç¬¦ä¸²æ‹¼æ¥ï¼‰
- çŠ¶æ€æ£€æŸ¥ï¼š< 0.5ms
- æ€»ä½“å½±å“ï¼š< 1ms/message

---

## æ‰©å±•æ–¹å‘

### 1. Per-Session åˆ‡æ¢

```typescript
// å‘½ä»¤æ”¯æŒ
if (text === "/concise on") {
  stateManager.setSessionMode(sessionKey, true);
}
```

### 2. æ™ºèƒ½æŠ‘åˆ¶

```typescript
// æ ¹æ®æ¶ˆæ¯ç±»å‹å†³å®š
if (messageType === "question") {
  // ä¸æŠ‘åˆ¶ï¼Œå…è®¸å›å¤
} else if (messageType === "status") {
  // æŠ‘åˆ¶ï¼Œåªè®°å½•
}
```

### 3. æŒ‡æ ‡ä¸ŠæŠ¥

```typescript
// Prometheus æ ¼å¼
concise_mode_suppressed_total{channel="telegram"} 1234
concise_mode_skipped_total{channel="telegram"} 56
```

### 4. é…ç½®çƒ­é‡è½½

```typescript
// ç›‘å¬é…ç½®å˜æ›´
api.on("config_changed", (newConfig) => {
  stateManager.updateChannels(newConfig.channels);
});
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ¶ˆæ¯æœªè¢«æŠ‘åˆ¶

**æ£€æŸ¥æ¸…å•ï¼š**
1. âœ… concise-mode æ’ä»¶å·²å¯ç”¨
2. âœ… é€šé“åœ¨é…ç½®åˆ—è¡¨ä¸­
3. âœ… send_message å·¥å…·è¢«è°ƒç”¨
4. âœ… after_tool_call hook è§¦å‘
5. âœ… suppress route å·²æ·»åŠ 
6. âœ… message_sending hook è§¦å‘

**è°ƒè¯•æ—¥å¿—ï¼š**
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export CONCISE_MODE_DEBUG=1

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/gateway.log | grep concise-mode
```

### é—®é¢˜ï¼šæµå¼è¾“å‡ºä»ç„¶æ˜¾ç¤º

**æ£€æŸ¥æ¸…å•ï¼š**
1. âœ… streaming.ts ä¸­ `isConciseMode = true`
2. âœ… `streamCfg.streamMode = "off"`
3. âœ… `onStreamDelta` è¢«åŒ…è£…ä¸º undefined
4. âœ… `onToolStart` è¢«åŒ…è£…ä¸º undefined

---

## ç‰ˆæœ¬å†å²

### v1.0 (2026-02-17)
- âœ… åŸºç¡€æ¶æ„é‡æ„
- âœ… State Pattern å®ç°
- âœ… Strategy Pattern å®ç°
- âœ… å®Œæ•´æµ‹è¯•è¦†ç›–
- âœ… æ¶æ„æ–‡æ¡£

### v0.1 (2026-02-15)
- âœ… åˆå§‹å®ç°
- âœ… åŸºç¡€ Hook é›†æˆ
