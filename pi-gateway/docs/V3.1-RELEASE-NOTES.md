# pi-gateway v3.1 Release Notes

**Release Date:** 2026-02-11
**BBD Test Results:** 240/240 pass âœ… (v3.0: 151, v3.1: 55, v2: 34) â€” é¦–æ¬¡å…¨ç»¿
**Spec:** `docs/HEARTBEAT-CRON-IMPLEMENTATION-SPEC.md`

---

## Overview

v3.1 adds autonomous agent capabilities â€” heartbeat, cron, and media â€” so pi-gateway agents can act without human prompts. Combined with v3.0's multi-agent routing and delegation, the gateway now supports fully autonomous agent workflows: scheduled tasks fire, heartbeats check for pending work, media flows in and out of Telegram, and agents coordinate via delegate_to_agent.

## What's New

### Heartbeat â€” Periodic Agent Wake-up âœ…

Agents can now self-check on a schedule. The gateway wakes the agent, the agent reads HEARTBEAT.md, and either reports back or stays quiet.

**Key behaviors:**
- `findBestMatch` pool strategy â€” heartbeat never spawns new processes or queues. If all RPC processes are busy, it retries twice (5s apart) then skips.
- `HEARTBEAT_OK` suppress â€” agent replies "HEARTBEAT_OK" â†’ gateway swallows it. Remaining text â‰¤ 300 chars also suppressed. Longer text = alert, delivered to bound channel.
- `isHeartbeatContentEffectivelyEmpty()` â€” skips API calls when HEARTBEAT.md contains only headings and empty checkboxes.
- `stripHeartbeatToken` â€” edge-strip algorithm handles `**HEARTBEAT_OK**`, `<b>HEARTBEAT_OK</b>`, and repeated tokens at start/end.
- `activeHours` window â€” heartbeat only runs during configured hours (e.g. 08:00â€“23:00 Asia/Shanghai).
- `skipWhenBusy` â€” skips when the agent's session has an active RPC process.
- Concurrent guard â€” prevents stacking if previous heartbeat is still running.

**Config:**
```jsonc
"heartbeat": {
  "enabled": true,
  "every": "30m",
  "activeHours": { "start": "08:00", "end": "23:00", "timezone": "Asia/Shanghai" },
  "skipWhenBusy": true
}
```

Per-agent override via `agents.list[].heartbeat`.

**Files:** `src/core/heartbeat-executor.ts` (GoldJaguar), `src/core/config.ts`

### Cron Engine â€” Scheduled Tasks âœ…

Two execution modes for different use cases:

**Isolated mode** (default): Cron fires â†’ creates dedicated session `cron:{jobId}` â†’ acquires RPC â†’ executes â†’ optionally announces result to bound channel. Independent of heartbeat.

**Main mode**: Cron fires â†’ injects system event into `SystemEventsQueue` â†’ wakes heartbeat via `requestNow()` â†’ heartbeat picks up events, uses `CRON_EVENT_PROMPT`, processes them, consumes events after response.

**Schedule types:** cron expressions (`0 9 * * *`), intervals (`every: "30m"`), one-shot (`at: "2026-02-12T14:00:00+08:00"` with auto-remove).

**Config:**
```jsonc
"cron": {
  "enabled": true,
  "jobs": [{
    "id": "daily-status",
    "schedule": { "kind": "cron", "expr": "0 9 * * *", "timezone": "Asia/Shanghai" },
    "payload": { "text": "Generate daily status report." },
    "mode": "isolated",
    "delivery": "announce"
  }]
}
```

**Files:** `src/core/cron.ts` (SwiftQuartz), `src/core/system-events.ts` (GoldJaguar)

### System Events Queue âœ…

Gateway-layer in-memory queue bridging cron main mode and heartbeat:

- `inject(sessionKey, text)` / `peek(sessionKey)` / `consume(sessionKey)`
- Max 20 events per session, 1h TTL, periodic GC via server tick
- Heartbeat checks for pending events before each run; if found, replaces prompt with `CRON_EVENT_PROMPT` and prepends event details

**File:** `src/core/system-events.ts` (GoldJaguar)

### Telegram Media Pipeline âœ…

Full inbound media chain from Telegram to agent:

| Layer | What | File |
|-------|------|------|
| Download | photo (largest), video, document, audio, voice â€” base64 with MIME inference | `telegram/media-download.ts` |
| STT | Groq Whisper (default) + OpenAI Whisper â€” OpenAI-compatible API | `telegram/audio-transcribe.ts` |
| Injection | `[media attached: N images]` prefix + media reply hint in prompt | `telegram/handlers.ts` |
| Outbound | `MEDIA:` directive parsing, `[photo]`/`[audio]` directives, security (block absolute/~ paths) | `telegram/media-send.ts` |

**Media reply prompt injection** (KeenDragon): Agents now receive instructions on how to reply with media using `MEDIA:` syntax. Without this, the outbound parsing was dead code.

**media_group batching**: Messages with same `media_group_id` are grouped with 1500ms debounce before batch processing.

**Files:** `src/plugins/builtin/telegram/` (KeenDragon)

### Discord Channel â€” Modular Rewrite âœ…

Complete rewrite from single-file to modular architecture:

- Streaming with 500ms throttle, 1800-char cutoff
- Guild-level slash commands: /new, /status, /compact, /think, /model, /stop, /help
- Tool call display (`â†’ tool args`) and thinking display (`> ðŸ’­`)
- Modular plugin loader support (`builtin/{name}/index.ts`)

**Files:** `src/plugins/builtin/discord/` (KeenUnion)

### Telegram pi_ Command Registration Fix âœ…

**Root cause:** `getPiCommands` used `pool.getForSession(tempSessionKey)` but the temp session key was never bound to any RPC process â†’ always returned null â†’ only local commands registered.

**Fix:** `getPiCommands` now uses `pool.findBestMatch()` to find an idle RPC process for command discovery, consistent with heartbeat's opportunistic strategy.

**File:** `src/server.ts` (KeenDragon, root cause by DarkFalcon)

## Architecture Decisions

| Decision | Rationale |
|----------|-----------|
| Heartbeat uses `findBestMatch` (never spawn) | Heartbeat must never degrade normal message processing. If no idle process, skip and retry next cycle. |
| Cron main mode injects events, doesn't dispatch directly | Main session context is valuable. Direct dispatch would create a separate session. System events let heartbeat process cron results with full session history. |
| `SystemEventsQueue` is in-memory only | Events are ephemeral (1h TTL). Persistence adds complexity for minimal value â€” if gateway restarts, pending events are lost but cron will re-fire. |
| `resolveMainSessionKey` shared between heartbeat and cron | Critical for main mode linkage. Cron injects to the same key heartbeat reads from. Initially implemented differently (gap caught in review). |
| Media reply hint injected at prompt level | Agent must know `MEDIA:` syntax exists to use it. Without prompt injection, outbound media parsing is dead code. |

## Test Coverage

| Suite | Tests | Status |
|-------|-------|--------|
| Heartbeat (H1â€“H16) | 16 | âœ… |
| Cron (C1â€“C14) | 14 | âœ… |
| Integration/Linkage (L1â€“L7) | 7 | âœ… |
| Media outbound (security, parsing) | 10 | âœ… |
| Media inbound (voice, note format) | 8 | âœ… |
| **v3.1 Total** | **55** | **âœ…** |

## Contributors

| Agent | Contribution |
|-------|-------------|
| GoldJaguar | HeartbeatExecutor rewrite, SystemEventsQueue, config.ts HeartbeatConfig, server.ts wiring, skipWhenBusy implementation |
| SwiftQuartz | CronEngine main mode, heartbeatWake callback, resolveMainSessionKey alignment |
| KeenDragon | Telegram media pipeline (download/STT/send), media reply prompt injection, pi_ command fix |
| KeenUnion | Discord modular rewrite, streaming, slash commands |
| MintTiger | 55 test scenarios (heartbeat/cron/linkage/media), interface alignment |
| DarkFalcon | Implementation spec (`HEARTBEAT-CRON-IMPLEMENTATION-SPEC.md`), OpenClaw architecture reference, review (3 gaps found: resolveMainSessionKey mismatch, skipWhenBusy unimplemented, GC unscheduled) |

## What's Next (v3.2)

- P2 Telegram: WEBP sticker understanding, TTS reply
- WebChat media support (KeenUnion)
- Cron CLI management (`gateway cron add/list/remove/history`)
- Heartbeat delivery to multiple channels (currently single binding)

---

*pi-gateway v3.1 â€” agents that act on their own schedule.*
