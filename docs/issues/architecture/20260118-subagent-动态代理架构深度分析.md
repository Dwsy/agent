# Subagent åŠ¨æ€ä»£ç†æ¶æ„æ·±åº¦åˆ†æ

## 1. å·¥ä½œåŸç†ï¼ˆæ¶æ„ä¸æ•°æ®æµï¼‰

### 1.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "ç”¨æˆ·è°ƒç”¨å±‚"
        A[subagent toolè°ƒç”¨] --> B[index.ts æ³¨å†Œå™¨]
    end

    subgraph "ä»£ç†å‘ç°å±‚"
        B --> C[discoverAgents]
        C --> D[loadAgentsFromDir ç”¨æˆ·]
        C --> E[loadAgentsFromDir é¡¹ç›®]
        D --> F[ä»£ç†é…ç½®Map]
        E --> F
    end

    subgraph "æ‰§è¡Œæ¨¡å¼è°ƒåº¦å±‚"
        B --> G{æ¨¡å¼è·¯ç”±}
        G --> H[SingleMode]
        G --> I[ParallelMode]
        G --> J[ChainMode]
    end

    subgraph "å•ä¸€æ‰§è¡Œæµç¨‹"
        H --> K[runSingleAgent]
        K --> L{ä»£ç†æ˜¯å¦å­˜åœ¨?}
        L -->|å¦| M[generateDynamicAgent]
        L -->|æ˜¯| N[ç›´æ¥æ‰§è¡Œ]
    end

    subgraph "åŠ¨æ€ä»£ç†ç”Ÿæˆå±‚"
        M --> M1[findExistingDynamicAgent]
        M1 --> M2{æ‰¾åˆ°åŒ¹é…?}
        M2 -->|æ˜¯| M3[å¤ç”¨å·²å­˜åœ¨]
        M2 -->|å¦| M4[buildDynamicAgentPrompt]
        M4 --> M5[è°ƒç”¨piè¿›ç¨‹ç”Ÿæˆ]
        M5 --> M6[parseJsonObject]
        M6 --> M7[saveDynamicAgentToFile]
        M7 --> M8[dynamicAgentToConfig]
    end

    subgraph "è¿›ç¨‹æ‰§è¡Œå±‚"
        N --> O[spawn piè¿›ç¨‹]
        M8 --> O
        O --> P[stdoutæµå¤„ç†]
        P --> Q[parseEventLine]
        Q --> R[emitUpdateå›è°ƒ]
        R --> S[è¿”å›ç»“æœ]
    end

    subgraph "æ–‡ä»¶ç³»ç»Ÿå±‚"
        style FS fill:#f9f,stroke:#333
        D --> FS1[~/.pi/agent/agents/]
        E --> FS2[.pi/agents/]
        M7 --> FS3[~/.pi/agent/agents/dynamic/]
    end
```

### 1.2 è¯¦ç»†æ•°æ®æµ

#### Phase 1: å·¥å…·è°ƒç”¨ä¸å‚æ•°è§£æ
```
ç”¨æˆ·è°ƒç”¨ â†’ pi.registerTool() â†’ execute() 
  â†“
è§£æ SubagentParamsSchema ({agent, task, tasks?, chain?})
  â†“
ç¡®å®šæ‰§è¡Œæ¨¡å¼ (single/parallel/chain äº’æ–¥)
  â†“
discoverAgents(ctx.cwd, agentScope)
  â†“
è¿”å› {agents[], projectAgentsDir}
```

#### Phase 2: åŠ¨æ€ä»£ç†ç”Ÿæˆæµç¨‹
```
runSingleAgent() â†’ æŸ¥æ‰¾ä»£ç†
  â†“
[æœªæ‰¾åˆ°] â†’ generateDynamicAgent()
  â†“
  1. findExistingDynamicAgent() - æœç´¢å·²æœ‰åŠ¨æ€ä»£ç†
     - è¯»å– ~/.pi/agent/agents/dynamic/ æ‰€æœ‰ .md æ–‡ä»¶
     - å¯åŠ¨ pi è¿›ç¨‹è¿›è¡Œè¯­ä¹‰åŒ¹é…
     - è¿”å›åŒ¹é…çš„ GeneratedAgentConfig æˆ– null
  â†“
  2. [æ— åŒ¹é…] â†’ buildDynamicAgentPrompt()
     - æ„å»º Chain-of-Thought å†³ç­–é“¾æç¤ºè¯
     - åŒ…å«: å¯ç”¨å·¥å…·åˆ—è¡¨ã€å¯ç”¨æŠ€èƒ½åˆ—è¡¨ã€å†³ç­–æ­¥éª¤
     - è¦æ±‚è¾“å‡º JSON: {name, description, systemPrompt, tools?}
  â†“
  3. è°ƒç”¨ pi è¿›ç¨‹ç”Ÿæˆ
     - spawn("pi", ["--mode", "json", "-p", "--no-session", ...])
     - è§£æ stdout JSON äº‹ä»¶æµ
     - æ•è· message_delta (éƒ¨åˆ†è¾“å‡º) â†’ onProgress()
     - æ•è· message_end â†’ è§£ææœ€ç»ˆé…ç½®
  â†“
  4. ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ
     - saveDynamicAgentToFile() â†’ ~/.pi/agent/agents/dynamic/{name}.md
     - Frontmatter: name, description, tools
     - Body: systemPrompt
  â†“
  5. è½¬æ¢ä¸º AgentConfig
  â†“
[æ‰¾åˆ°/ç”Ÿæˆ] â†’ ç»§ç»­æ‰§è¡Œ
```

#### Phase 3: è¿›ç¨‹æ‰§è¡Œæµç¨‹
```
å‡†å¤‡æ‰§è¡Œå‚æ•°
  â†“
æ„å»º pi è¿›ç¨‹å‚æ•°:
  args = ["--mode", "json", "-p", "--no-session"]
  if model: args.push("--model", agent.model)
  if provider: args.push("--provider", agent.provider)
  if tools: args.push("--tools", tools.join(","))
  if systemPrompt: writeTempFile() â†’ --append-system-prompt
  â†“
spawn("pi", args, {cwd, stdio: ["ignore", "pipe", "pipe"]})
  â†“
æµå¤„ç†å¾ªç¯:
  stdout.on("data") â†’ buffer
  split("\n") â†’ é€è¡Œå¤„ç†
  parseEventLine(line) â†’ JSON äº‹ä»¶
  â†“
äº‹ä»¶åˆ†å‘:
  - type === "message_end"
     â†’ currentResult.messages.push(msg)
     â†’ accumulateUsage()
     â†’ emitUpdate()
  - type === "tool_result_end"
     â†’ currentResult.messages.push(event.message)
     â†’ emitUpdate()
  â†“
proc.on("close") â†’ è§£ææœ€ç»ˆ buffer
  â†“
è¿”å› SingleResult {
  agent, agentSource, task, exitCode,
  messages, stderr, usage, startTime, endTime,
  status, stopReason, model
}
```

### 1.3 å…³é”®æ•°æ®ç»“æ„æµè½¬

```typescript
// 1. ç”¨æˆ·è¾“å…¥
SubagentParams {
  agent: string
  task: string
  agentScope: "user" | "project" | "both"
}

// 2. å‘ç°ä»£ç†å
AgentConfig {
  name: string
  description: string
  systemPrompt: string
  tools?: string[]
  model?: string
  provider?: string
  source: "user" | "project" | "dynamic"
  filePath: string
}

// 3. åŠ¨æ€ç”Ÿæˆä¸­æ®µ
GeneratedAgentConfig {
  name: string
  description: string
  systemPrompt: string
  tools?: string[]
  filePath?: string
  origin: "generated" | "matched"
  availableTools: string[]
  availableSkills: string[]
}

// 4. æ‰§è¡Œç»“æœ
SingleResult {
  agent: string
  agentSource: AgentSource
  task: string
  exitCode: number
  messages: Message[]
  stderr: string
  usage: UsageStats
  status: "running" | "searching" | "generating" | "completed" | "error"
  startTime: number
  endTime?: number
}
```

---

## 2. ç»“æ„è®¾è®¡åŸå› ï¼ˆè®¾è®¡å†³ç­–ï¼‰

### 2.1 ä¸ºä»€ä¹ˆè¦åˆ†ç¦»åŠ¨æ€ç”Ÿæˆåˆ°ç‹¬ç«‹è¿›ç¨‹ï¼Ÿ

**ç†ç”± 1: ä¸Šä¸‹æ–‡éš”ç¦»**
- åŠ¨æ€ä»£ç†ç”Ÿæˆéœ€è¦ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡çª—å£
- é¿å…ä¸» Agent çš„ token å ç”¨
- ç”Ÿæˆè¿‡ç¨‹å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ¨¡å‹/Provider

**ç†ç”± 2: æ•…éšœéš”ç¦»**
```typescript
// dynamic-agent.ts:549-547
const finish = (value: GeneratedAgentConfig | null) => {
  if (resolved) return;
  resolved = true;
  cleanupTempFiles(tmp.filePath, tmp.dir);
  resolve(value);
};
```
- ä½¿ç”¨ `resolved` æ ‡å¿—é˜²æ­¢é‡å¤è§£æ
- ç‹¬ç«‹é”™è¯¯å¤„ç†ï¼Œä¸æ±¡æŸ“ä¸»æµç¨‹

**ç†ç”± 3: è¶…æ—¶æ§åˆ¶**
```typescript
const timeout = setTimeout(() => finish(null), 180000); // 3 minutes
```
- é¿å…ç”Ÿæˆè¿‡ç¨‹æ— é™ç­‰å¾…
- 3 åˆ†é’Ÿåè‡ªåŠ¨ç»“æŸï¼Œè¿”å› null

### 2.2 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Markdown Frontmatter å­˜å‚¨ä»£ç†é…ç½®ï¼Ÿ

**ç†ç”± 1: äººç±»å¯è¯»**
```markdown
---
name: "worker"
description: "General purpose worker agent"
tools: read, bash, edit
---

You are a worker agent...
```
- é…ç½®å’Œç³»ç»Ÿæç¤ºè‡ªç„¶åˆ†ç¦»
- æ˜“äºæ‰‹åŠ¨ç¼–è¾‘å’Œç‰ˆæœ¬æ§åˆ¶

**ç†ç”± 2: æ‰©å±•æ€§**
```typescript
// agents.ts:104-125
const { frontmatter, body } = parseFrontmatter(content);
agents.push({
  name: frontmatter.name,
  description: frontmatter.description,
  tools: frontmatter.tools?.split(",").map(t => t.trim()),
  model: frontmatter.model,
  provider: frontmatter.provider,
  systemPrompt: body,  // ç›´æ¥å–æ­£æ–‡
});
```
- å¯ä»¥éšæ„æ·»åŠ æ–°å­—æ®µ (model, provider ç­‰)
- å‘åå…¼å®¹æ—§æ–‡ä»¶

**ç†ç”± 3: æ–‡ä»¶å³è®°å¿†**
- ä»£ç†é…ç½®æŒä¹…åŒ–åˆ°æ–‡ä»¶ç³»ç»Ÿ
- æ”¯æŒé¡¹ç›®çº§ `.pi/agents/` ç›®å½•
- ä¾¿äº git è¿½è¸ªå˜æ›´

### 2.3 ä¸ºä»€ä¹ˆè¦å®ç°ä¸‰ç§æ‰§è¡Œæ¨¡å¼ï¼Ÿ

**å†³ç­–**: ç­–ç•¥æ¨¡å¼çš„åº”ç”¨

```typescript
// modes/base.ts:20-23
export interface ExecutionMode {
  execute(ctx: ExecutionContext, params: any): Promise<ModeResult>;
}

const singleMode = new SingleMode();
const parallelMode = new ParallelMode();
const chainMode = new ChainMode();
```

**è®¾è®¡ç†ç”±**:

1. **Single Mode** - æœ€å¸¸ç”¨åœºæ™¯
   - å•ä»»åŠ¡å§”æ´¾
   - ç‹¬ç«‹ä¸Šä¸‹æ–‡
   - ç®€å•ç›´æ¥

2. **Parallel Mode** - æé«˜å¹¶å‘æ•ˆç‡
   ```typescript
   const MAX_PARALLEL_TASKS = 8;
   // parallel.ts:21-31
   if (tasks.length > MAX_PARALLEL_TASKS) {
     return {
       content: [{ type: "text", text: `Too many parallel tasks...` }],
     };
   }
   ```
   - é™åˆ¶å¹¶å‘æ•°é˜²æ­¢èµ„æºè€—å°½
   - ä½¿ç”¨ Promise.all å¹¶è¡Œæ‰§è¡Œ

3. **Chain Mode** - æ”¯æŒæ•°æ®æµæ°´çº¿
   ```typescript
   // chain.ts:23-24
   const results: SingleResult[] = [];
   let previousOutput = "";
   ```
   - æ”¯æŒ `{previous}` å ä½ç¬¦
   - å‰ä¸€ä¸ªä»£ç†çš„è¾“å‡ºä¼ é€’ç»™ä¸‹ä¸€ä¸ª

### 2.4 ä¸ºä»€ä¹ˆè¦å®ç°æ™ºèƒ½å¤ç”¨æœºåˆ¶ï¼Ÿ

**é—®é¢˜**: é¢‘ç¹ç”Ÿæˆç›¸åŒä»£ç†ä¼šæµªè´¹ token å’Œæ—¶é—´

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// dynamic-agent.ts:518-531
const existing = await findExistingDynamicAgent(agentName, task, onProgress);
if (existing) {
  onProgress({ stage: "done", text: `âœ“ Found existing "${agentName}" agent` });
  existing.availableTools = availableTools.map(t => t.name);
  existing.availableSkills = availableSkills.map(s => s.name);
  return existing;
}
```

**å¤ç”¨æœºåˆ¶**:
1. è¯»å–æ‰€æœ‰åŠ¨æ€ä»£ç†æ–‡ä»¶
2. æ„å»ºè¯­ä¹‰åŒ¹é…æç¤ºè¯
3. è°ƒç”¨ AI åˆ¤æ–­æ˜¯å¦å¤ç”¨
4. è¿”å›åŒ¹é…çš„ä»£ç†é…ç½®

**ä¼˜åŠ¿**:
- èŠ‚çœ token æ¶ˆè€—
- æé«˜å“åº”é€Ÿåº¦
- ä¿ƒè¿›ä»£ç†è´¨é‡è¿­ä»£

### 2.5 ä¸ºä»€ä¹ˆè¦åˆ†ç¦»å·¥å…·å’ŒæŠ€èƒ½ï¼Ÿ

**åŒºåˆ«**:
- **å·¥å…· (Tools)**: é€šè¿‡ API è°ƒç”¨ï¼Œåœ¨ Pi Agent æ ¸å¿ƒä¸­æ³¨å†Œ
  ```typescript
  // frontmatter
  tools: read, bash, edit
  ```
- **æŠ€èƒ½ (Skills)**: é€šè¿‡ CLI è°ƒç”¨ï¼Œç‹¬ç«‹è„šæœ¬
  ```typescript
  // dynamic-agent.ts:324
  "For code analysis tasks, use the ace-tool skill: `bun ~/.pi/agent/skills/ace-tool/client.ts search <query>`"
  ```

**è®¾è®¡ç†ç”±**:
1. **å·¥å…·** æ˜¯åŸºç¡€èƒ½åŠ›ï¼Œéœ€è¦é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿ
2. **æŠ€èƒ½** æ˜¯é¢†åŸŸæ‰©å±•ï¼Œå¯ä»¥ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
3. æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤

### 2.6 ä¸ºä»€ä¹ˆè¦æ”¯æŒä¸‰çº§ä½œç”¨åŸŸï¼Ÿ

```typescript
export type AgentScope = "user" | "project" | "dynamic";
```

**è®¾è®¡ç†ç”±**:

1. **user** (`~/.pi/agent/agents/`)
   - å…¨å±€å¯ç”¨çš„ä»£ç†
   - è·¨é¡¹ç›®å¤ç”¨
   - æ‰‹åŠ¨åˆ›å»ºæˆ–æå‡

2. **project** (`.pi/agents/`)
   - é¡¹ç›®ç‰¹å®šçš„ä»£ç†
   - åŒ…å«é¡¹ç›®é¢†åŸŸçŸ¥è¯†
   - ä»£ç åº“å†…ç‰ˆæœ¬æ§åˆ¶

3. **dynamic** (`~/.pi/agent/agents/dynamic/`)
   - è‡ªåŠ¨ç”Ÿæˆçš„ä¸´æ—¶ä»£ç†
   - æ”¯æŒå¤ç”¨å’Œæå‡
   - ä½œä¸º"æ²™ç®±"ç¯å¢ƒ

**å®‰å…¨æœºåˆ¶**:
```typescript
// index.ts:109-130
if ((agentScope === "project" || agentScope === "both") && confirmProjectAgents) {
  const projectAgentsRequested = agents.filter(a => a.source === "project");
  if (projectAgentsRequested.length > 0) {
    const ok = await ctx.ui.confirm(
      "Run project-local agents?",
      `Agents: ${names}\nSource: ${dir}\n\nProject agents are repo-controlled.`
    );
    if (!ok) return { content: [{ type: "text", text: "Canceled" }]};
  }
}
```
- é¡¹ç›®ä»£ç†éœ€è¦ç”¨æˆ·ç¡®è®¤
- é˜²æ­¢æ¶æ„ä»“åº“æ‰§è¡Œä»»æ„ä»£ç†

---

## 3. ä½¿ç”¨çš„æ¨¡å¼ï¼ˆè®¾è®¡æ¨¡å¼ã€æƒ¯ç”¨æ³•ï¼‰

### 3.1 ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

**å®ç°**: ä¸‰ç§æ‰§è¡Œæ¨¡å¼å¯äº’æ¢

```typescript
// modes/base.ts
export interface ExecutionMode {
  execute(ctx: ExecutionContext, params: any): Promise<ModeResult>;
}

// index.ts
const singleMode = new SingleMode();
const parallelMode = new ParallelMode();
const chainMode = new ChainMode();

// è·¯ç”±é€»è¾‘
if (params.chain && params.chain.length > 0) {
  return chainMode.execute(executionContext, { chain: params.chain });
}
if (params.tasks && params.tasks.length > 0) {
  return parallelMode.execute(executionContext, { tasks: params.tasks });
}
if (params.agent && params.task) {
  return singleMode.execute(executionContext, { agent: params.agent, task: params.task });
}
```

**ä¼˜ç‚¹**:
- å¼€é—­åŸåˆ™: æ˜“äºæ·»åŠ æ–°æ¨¡å¼
- å•ä¸€èŒè´£: æ¯ä¸ªæ¨¡å¼ç‹¬ç«‹å®ç°
- è¿è¡Œæ—¶åˆ‡æ¢: æ ¹æ®å‚æ•°åŠ¨æ€é€‰æ‹©

### 3.2 å·¥å‚æ¨¡å¼ (Factory Pattern)

**å®ç°**: createAgent å‡½æ•°æ ¹æ®æ¨¡æ¿åˆ›å»ºä»£ç†

```typescript
// utils/agent-creator.ts:93-150
export function createAgent(options: CreateAgentOptions) {
  const scope = options.scope ?? "user";
  const agentDir = getAgentDir(scope);

  // ä½¿ç”¨æ¨¡æ¿æˆ–è‡ªå®šä¹‰æç¤ºè¯
  let systemPrompt: string;
  if (options.customPrompt) {
    systemPrompt = options.customPrompt;
  } else if (options.template) {
    systemPrompt = AGENT_TEMPLATES[options.template];
  } else {
    systemPrompt = AGENT_TEMPLATES.worker;
  }

  // æ„å»º Frontmatter
  const frontmatter = `---\n${fields.join("\n")}\n---`;
  const content = `${frontmatter}\n\n${systemPrompt}`;

  // å†™å…¥æ–‡ä»¶
  const filePath = path.join(agentDir, `${safeName}.md`);
  fs.writeFileSync(filePath, content, "utf-8");
}
```

**æ¨¡æ¿ç³»ç»Ÿ**:
```typescript
const AGENT_TEMPLATES: Record<AgentTemplate, string> = {
  worker: "You are a worker agent with full capabilities...",
  scout: "You are a scout agent. Quickly investigate...",
  reviewer: "You are a code reviewer...",
  custom: "",
};
```

### 3.3 è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

**å®ç° 1**: è¿›åº¦å›è°ƒ (onProgress)

```typescript
// dynamic-agent.ts:130-135
export interface DynamicAgentGeneratorOptions {
  agentName: string;
  task: string;
  targetScope?: "user" | "project" | "dynamic";
  onProgress?: (progress: {
    stage: "search" | "create" | "save" | "error" | "done";
    text: string;
    details?: { ... }
  }) => void;
}

// ä½¿ç”¨
const generated = await generateDynamicAgent({
  agentName,
  task,
  onProgress: (progress) => {
    switch (progress.stage) {
      case "search":
        emitUpdate("searching", `ğŸ” ${progress.text}`);
        break;
      case "create":
        emitUpdate("generating", `âš™ï¸ ${progress.text}`);
        break;
    }
  }
});
```

**å®ç° 2**: ç»“æœæ›´æ–°å›è°ƒ (onUpdate)

```typescript
// types.ts:68-70
export interface OnUpdateCallback {
  (partial: {
    content: Array<{ type: string; text?: string }>;
    details?: SubagentDetails;
  }): void;
}

// executor/runner.ts:191-197
const emitUpdate = () => {
  if (onUpdate) {
    onUpdate({
      content: [{ type: "text", text: "(running...)" }],
      details: makeDetails([currentResult]),
    });
  }
};
```

### 3.4 è£…é¥°å™¨æ¨¡å¼ (Decorator Pattern)

**å®ç°**: è¿½åŠ ç³»ç»Ÿæç¤ºè¯

```typescript
// executor/runner.ts:165-174
let tmpPromptPath: string | null = null;

if (agent.systemPrompt.trim()) {
  const tmp = writePromptToTempFile(agent.name, agent.systemPrompt);
  tmpPromptDir = tmp.dir;
  tmpPromptPath = tmp.filePath;
  args.push("--append-system-prompt", tmpPromptPath);
}

args.push(`Task: ${effectiveTask}`);
```

**æ•ˆæœ**:
- ä»£ç†çš„ç³»ç»Ÿæç¤ºè¯ä½œä¸º"è£…é¥°å™¨"
- è¿½åŠ åˆ°åŸºç¡€æç¤ºè¯å
- åŠ¨æ€ agent çš„å…ƒä¿¡æ¯ä¹Ÿè¢«è¿½åŠ :
  ```typescript
  // executor/runner.ts:109-123
  const effectiveTask = isDynamicAgent
    ? [
        `[Dynamic agent "${agentName}" created and saved to ${filePath}]`,
        `Generation: generated from model`,
        `Available tools: ${tools}`,
        `Available skills: ${skills}`,
        `Original task: ${task}`,
      ].join("\n\n")
    : task;
  ```

### 3.5 ç”Ÿæˆå™¨æ¨¡å¼ (Builder Pattern)

**å®ç°**: æ„å»ºåŠ¨æ€ä»£ç†ç”Ÿæˆæç¤ºè¯

```typescript
// dynamic-agent.ts:239-383
export function buildDynamicAgentPrompt(
  agentName: string,
  task: string,
  availableTools: ToolDescription[],
  availableSkills: SkillDescription[]
): string {
  const toolsList = availableTools.map(t =>
    `- **${t.name}**: ${t.description}\n  - Use when: ${t.useCase}`
  ).join("\n\n");

  const skillsList = availableSkills.map(s =>
    `- **${s.name}**: ${s.description}\n  - Use when: ${s.useCase}`
  ).join("\n\n");

  return `You are an Agent Generator...

**Agent Request:**
- Name: ${agentName}
- Task: ${task}

## Available Tools
${toolsList}

## Available Skills
${skillsList}

## Decision Chain (Chain of Thought)
### Step 1: Task Analysis
### Step 2: Tool Selection
...
`;
}
```

**ç‰¹ç‚¹**:
- é€æ­¥æ„å»ºå¤æ‚æç¤ºè¯
- ç»“æ„åŒ–è¾“å…¥ï¼ˆå·¥å…·ã€æŠ€èƒ½åˆ—è¡¨ï¼‰
- æ¸…æ™°çš„é˜¶æ®µåˆ’åˆ†

### 3.6 é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)

**å®ç° 1**: GeneratedAgentConfig â†’ AgentConfig

```typescript
// dynamic-agent.ts:650-661
export function dynamicAgentToConfig(
  generated: GeneratedAgentConfig,
  requestedName: string
): AgentConfig {
  return {
    name: generated.name || requestedName,
    description: generated.description || "Dynamic agent",
    systemPrompt: generated.systemPrompt,
    model: generated.model,
    tools: generated.tools,
    provider: generated.provider,
    source: "dynamic",  // é€‚é…æ¥æºæ ‡è¯†
    filePath: generated.filePath ?? "",
  };
}
```

**å®ç° 2**: è§£æ Frontmatter

```typescript
// agents.ts:18-51
function parseFrontmatter(content: string): {
  frontmatter: Record<string, string>;
  body: string;
} {
  const frontmatter: Record<string, string> = {};

  if (!normalized.startsWith("---")) {
    return { frontmatter, body: normalized };
  }

  const endIndex = normalized.indexOf("\n---", 3);
  const frontmatterBlock = normalized.slice(4, endIndex);
  const body = normalized.slice(endIndex + 4).trim();

  for (const line of frontmatterBlock.split("\n")) {
    const match = line.match(/^([\w-]+):\s*(.*)$/);
    if (match) {
      let value = match[2].trim();
      if ((value.startsWith('"') && value.endsWith('"'))) {
        value = value.slice(1, -1);
      }
      frontmatter[match[1]] = value;
    }
  }

  return { frontmatter, body };
}
```

### 3.7 æ‡’åŠ è½½æ¨¡å¼ (Lazy Loading)

**å®ç°**: é¡¹ç›®ä»£ç†æŒ‰éœ€å‘ç°

```typescript
// index.ts:393-408
function showAgentList(ctx: any): void {
  // Re-discover agents to get the latest from the current directory
  const discovery = discoverAgents(ctx.cwd, "both");
  const projectAgents = discovery.agents.filter(a => a.source === "project");

  // Register any newly discovered project agents
  projectAgents.forEach(createAgentCommand);
  showAgentList(ctx);
}
```

**ç†ç”±**:
- é¦–æ¬¡åŠ è½½æ—¶åªæ³¨å†Œç”¨æˆ·ä»£ç†
- è°ƒç”¨ `/sub` æ—¶å†æ‰«æé¡¹ç›®ä»£ç†
- é¿å…ä¸å¿…è¦çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

### 3.8 Pipeline Pattern (ç®¡é“æ¨¡å¼)

**å®ç°**: Chain Mode çš„æ•°æ®ä¼ é€’

```typescript
// modes/chain.ts:23-38
for (const step of chain) {
  const result = await runSingleAgent({
    defaultCwd,
    agents,
    agentName: step.agent,
    // æ›¿æ¢ {previous} å ä½ç¬¦
    task: step.task.replace("{previous}", previousOutput),
    cwd: step.cwd,
    step: i + 1,
    signal,
    onUpdate,
    makeDetails,
  });

  results.push(result);
  previousOutput = getFinalOutput(result.messages);
}
```

**ç‰¹ç‚¹**:
- ä¸²è¡Œæ‰§è¡Œå¤šä¸ªä»£ç†
- å‰ä¸€ä¸ªè¾“å‡ºä½œä¸ºåä¸€ä¸ªè¾“å…¥
- æ”¯æŒå ä½ç¬¦æ›¿æ¢

### 3.9 Resilience Pattern (éŸ§æ€§æ¨¡å¼)

**å®ç° 1**: è¶…æ—¶ä¿æŠ¤

```typescript
// dynamic-agent.ts:561
const timeout = setTimeout(() => finish(null), 180000);

// dynamic-agent.ts:621-625
proc.on("close", () => {
  clearTimeout(timeout);
  finish(null);
});

proc.on("error", () => {
  clearTimeout(timeout);
  finish(null);
});
```

**å®ç° 2**: ä¿¡å·ä¸­æ–­

```typescript
// executor/runner.ts:186-198
if (signal) {
  const killProc = () => {
    wasAborted = true;
    proc.kill("SIGTERM");
    setTimeout(() => {
      if (!proc.killed) proc.kill("SIGKILL");
    }, 5000);
  };

  if (signal.aborted) killProc();
  else signal.addEventListener("abort", killProc, { once: true });
}
```

### 3.10 æƒ¯ç”¨æ³•

**æƒ¯ç”¨æ³• 1**: Node.js Stream å¤„ç†

```typescript
// executor/runner.ts:156-163
proc.stdout.on("data", (data) => {
  buffer += data.toString();
  const lines = buffer.split("\n");
  buffer = lines.pop() || "";
  for (const line of lines) {
    processLine(line);
  }
});
```

**æƒ¯ç”¨æ³• 2**: ä¸´æ—¶æ–‡ä»¶æ¸…ç†

```typescript
// utils/tempfiles.ts:14-23
const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), "pi-subagent-"));
const filePath = path.join(tempDir, `${prefix}.md`);
fs.writeFileSync(filePath, content, "utf-8");

// ä½¿ç”¨å
function cleanupTempFiles(filePath: string | null, dir: string | null) {
  if (filePath) fs.unlinkSync(filePath);
  if (dir) fs.rmSync(dir, { recursive: true });
}
```

**æƒ¯ç”¨æ³• 3**: JSON é˜²å¾¡æ€§è§£æ

```typescript
// dynamic-agent.ts:192-197
function parseJsonObject<T>(text: string): T | null {
  const match = text.match(/\{[\s\S]*\}/);
  if (!match) return null;
  try {
    return JSON.parse(match[0]) as T;
  } catch {
    return null;
  }
}
```

---

## 4. ä¾èµ–å…³ç³»å’Œäº¤äº’

### 4.1 æ¨¡å—ä¾èµ–å›¾

```mermaid
graph LR
    subgraph "å…¥å£å±‚"
        A[index.ts]
    end

    subgraph "æ¨¡å¼å±‚"
        B[modes/single.ts]
        C[modes/parallel.ts]
        D[modes/chain.ts]
        E[modes/base.ts]
    end

    subgraph "æ‰§è¡Œå±‚"
        F[executor/runner.ts]
        G[executor/parser.ts]
    end

    subgraph "æ ¸å¿ƒåŠŸèƒ½å±‚"
        H[agents.ts]
        I[dynamic-agent.ts]
        J[utils/agent-creator.ts]
        K[utils/tempfiles.ts]
        L[utils/concurrency.ts]
    end

    subgraph "UI å±‚"
        M[ui/renderer.ts]
    end

    subgraph "ç±»å‹å±‚"
        N[types.ts]
    end

    A --> B
    A --> C
    A --> D
    B --> E
    C --> E
    D --> E
    B --> F
    C --> F
    D --> F
    F --> G
    F --> I
    A --> H
    F --> H
    I --> K
    J --> K
    C --> L
    A --> M
    B --> N
    C --> N
    D --> N
    F --> N
    I --> N
```

### 4.2 å…³é”®äº¤äº’åºåˆ—

#### äº¤äº’ 1: å®Œæ•´çš„åŠ¨æ€ä»£ç†ç”Ÿæˆå’Œæ‰§è¡Œ

```typescript
// 1. ç”¨æˆ·è°ƒç”¨
subagent({ agent: "log-analyst", task: "åˆ†ææ—¥å¿—..." })

// 2. index.ts: æ‰§è¡Œ
execute(_toolCallId, params, onUpdate, ctx, signal)
  â†“ discoverAgents(ctx.cwd, agentScope)
    â†“ è¿”å› { agents: [], projectAgentsDir }
  â†“ singleMode.execute(executionContext, { agent, task, ... })
    â†“ runSingleAgent({ defaultCwd, agents, agentName, task, ... })
      â†“ agents.find(a => a.name === agentName) â†’ null
      â†“ generateDynamicAgent({ agentName, task, onProgress })
        â†“ findExistingDynamicAgent() â†’ null
        â†“ buildDynamicAgentPrompt() â†’ é•¿æç¤ºè¯
        â†“ spawn("pi", ["--mode", "json", "-p", ...])
          â†“ onProgress({ stage: "create", text: "ç”Ÿæˆä¸­..." })
          â†“ è§£æ message_delta / message_end
          â†“ saveDynamicAgentToFile() â†’ ~/.pi/agent/agents/dynamic/
          â†“ return GeneratedAgentConfig
      â†“ dynamicAgentToConfig(generated, agentName)
        â†“ è¿”å› AgentConfig
      â†“ spawn("pi", ["--mode", "json", "-p", agent.systemPrompt])
        â†“ å¤„ç† stdout JSON äº‹ä»¶
        â†“ onUpdate({ content, details })
      â†“ è¿”å› SingleResult
```

#### äº¤äº’ 2: ä»£ç†å‘ç°å’Œè·¯ç”±

```typescript
// index.ts
execute() {
  const discovery = discoverAgents(ctx.cwd, params.agentScope);

  // agents.ts:131-138
  discoverAgents(cwd, scope) {
    const userAgents = loadAgentsFromDir(userDir, "user");
    const projectAgents = loadAgentsFromDir(projectAgentsDir, "project");

    const agentMap = new Map<string, AgentConfig>();
    for (const agent of userAgents) agentMap.set(agent.name, agent);
    for (const agent of projectAgents) agentMap.set(agent.name, agent);

    return { agents: Array.from(agentMap.values()), projectAgentsDir };
  }

  // è·¯ç”±åˆ°å¯¹åº”æ¨¡å¼
  if (params.chain) return chainMode.execute(...);
  if (params.tasks) return parallelMode.execute(...);
  if (params.agent && params.task) return singleMode.execute(...);
}
```

#### äº¤äº’ 3: è¿›ç¨‹ä¿¡å·å¤„ç†

```typescript
// executor/runner.ts
let wasAborted = false;

// è®¾ç½®ä¿¡å·ç›‘å¬
if (signal) {
  const killProc = () => {
    wasAborted = true;
    proc.kill("SIGTERM");
    setTimeout(() => {
      if (!proc.killed) proc.kill("SIGKILL");
    }, 5000);
  };

  if (signal.aborted) killProc();
  else signal.addEventListener("abort", killProc, { once: true });
}

// è¿›ç¨‹é€€å‡º
proc.on("close", (code) => {
  if (wasAborted) throw new Error("Subagent was aborted");
  currentResult.exitCode = code ?? 0;
  return currentResult;
});
```

#### äº¤äº’ 4: Frontmatter è§£æ

```typescript
// agents.ts:18-51
function parseFrontmatter(content: string) {
  const frontmatter: Record<string, string> = {};

  if (!content.startsWith("---")) {
    return { frontmatter, body: content };
  }

  const endIndex = content.indexOf("\n---", 3);
  const frontmatterBlock = content.slice(4, endIndex);
  const body = content.slice(endIndex + 4).trim();

  for (const line of frontmatterBlock.split("\n")) {
    const match = line.match(/^([\w-]+):\s*(.*)$/);
    if (match) {
      let value = match[2].trim();
      if (value.startsWith('"') && value.endsWith('"')) {
        value = value.slice(1, -1);
      }
      frontmatter[match[1]] = value;
    }
  }

  return { frontmatter, body };
}

// åœ¨ loadAgentsFromDir ä¸­ä½¿ç”¨
export function loadAgentsFromDir(dir: string, source: AgentSource) {
  const content = fs.readFileSync(filePath, "utf-8");
  const { frontmatter, body } = parseFrontmatter(content);

  agents.push({
    name: frontmatter.name,
    description: frontmatter.description,
    tools: frontmatter.tools?.split(",").map(t => t.trim()),
    systemPrompt: body,
    source,
    filePath,
  });
}
```

### 4.3 å¤–éƒ¨ä¾èµ–

| ä¾èµ– | ç”¨é€” | å¯¼å…¥ä½ç½® |
|------|------|----------|
| `node:fs` | æ–‡ä»¶ç³»ç»Ÿæ“ä½œ | å…¨å±€ |
| `node:path` | è·¯å¾„å¤„ç† | å…¨å±€ |
| `node:os` | æ“ä½œç³»ç»Ÿä¿¡æ¯ | agents.ts, dynamic-agent.ts |
| `node:child_process` | è¿›ç¨‹æ‰§è¡Œ | executor/runner.ts, dynamic-agent.ts |
| `@sinclair/typebox` | æ¨¡å¼éªŒè¯ | index.ts |
| `@mariozechner/pi-agent-core` | æ ¸å¿ƒç±»å‹ | index.ts |
| `@mariozechner/pi-ai` | AI ç›¸å…³ç±»å‹ | index.ts |

### 4.4 å…³é”®æ•°æ®æµè¾¹ç•Œ

**è¾¹ç•Œ 1: ç”¨æˆ·ç•Œé¢ â†’ å·¥å…·æ‰§è¡Œ**
```
ç”¨æˆ·è¾“å…¥
  â†“ JSON Schema éªŒè¯ (TypeBox)
  â†“ SubagentParams
  â†“ å·¥å…· execute()
  â†“ OnUpdateCallback (å®æ—¶æ¨é€åˆ° UI)
```

**è¾¹ç•Œ 2: åŠ¨æ€ç”Ÿæˆå™¨ â†’ AI æ¨¡å‹**
```
æ„å»ºæç¤ºè¯
  â†“ å†™å…¥ä¸´æ—¶æ–‡ä»¶
  â†“ spawn("pi", ...)
  â†“ JSON æ¨¡å¼è¾“å‡º
  â†“ parseJsonObject()
  â†“ GeneratedAgentConfig
```

**è¾¹ç•Œ 3: æ‰§è¡Œå™¨ â†’ å­è¿›ç¨‹**
```
AgentConfig
  â†“ è½¬æ¢ä¸ºå‘½ä»¤è¡Œå‚æ•°
  â†“ spawn()
  â†“ stdout æµ (JSON äº‹ä»¶)
  â†“ è§£æäº‹ä»¶
  â†“ SingleResult
```

### 4.5 å¾ªç¯ä¾èµ–åˆ†æ

**æ— å¾ªç¯ä¾èµ–**:
- æ‰€æœ‰æ¨¡å—å½¢æˆæ¸…æ™°çš„ DAG (æœ‰å‘æ— ç¯å›¾)
- ç±»å‹å±‚ (types.ts) è¢«æ‰€æœ‰æ¨¡å—ä¾èµ–
- å…¥å£å±‚ (index.ts) ä¾èµ–æ¨¡å¼å±‚å’Œæ ¸å¿ƒåŠŸèƒ½å±‚
- æ¨¡å¼å±‚ä¾èµ–æ‰§è¡Œå±‚
- æ‰§è¡Œå±‚ä¾èµ–æ ¸å¿ƒåŠŸèƒ½å±‚
- UI å±‚ç‹¬ç«‹ï¼Œä»…ç”¨äºæ¸²æŸ“

**ä¾èµ–åè½¬åŸåˆ™åº”ç”¨**:
- `ExecutionMode` æ¥å£å®šä¹‰æ‰§è¡Œå¥‘çº¦
- å…·ä½“æ¨¡å¼ç±»å®ç°æ¥å£
- ä¸»å…¥å£é€šè¿‡æ¥å£è°ƒç”¨ï¼Œä¸ä¾èµ–å…·ä½“å®ç°

---

## 5. æ€»ç»“

### 5.1 æ¶æ„ä¼˜åŠ¿

1. **çµæ´»æ€§**: ä¸‰ç§æ‰§è¡Œæ¨¡å¼é€‚åº”ä¸åŒåœºæ™¯
2. **æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°æ¨¡å¼ã€æ–°ä»£ç†
3. **éš”ç¦»æ€§**: ç‹¬ç«‹è¿›ç¨‹æ‰§è¡Œï¼Œä¸Šä¸‹æ–‡éš”ç¦»
4. **éŸ§æ€§**: è¶…æ—¶ä¿æŠ¤ã€ä¿¡å·ä¸­æ–­ã€é”™è¯¯æ¢å¤
5. **å¯è§‚æµ‹æ€§**: å®æ—¶è¿›åº¦å›è°ƒã€è¯¦ç»†ç»“æœç»“æ„

### 5.2 è®¾è®¡äº®ç‚¹

1. **åŠ¨æ€ä»£ç†** â€” å³æ—¶ç”Ÿæˆï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
2. **æ™ºèƒ½å¤ç”¨** â€” è¯­ä¹‰åŒ¹é…ï¼Œé¿å…é‡å¤ç”Ÿæˆ
3. **ä¸‰çº§ä½œç”¨åŸŸ** â€” ç”¨æˆ·ã€é¡¹ç›®ã€åŠ¨æ€åˆ†çº§ç®¡ç†
4. **Markdown Frontmatter** â€” äººæœºå¯è¯»çš„é…ç½®æ ¼å¼
5. **é“¾å¼å†³ç­–** â€” CoT æç¤ºè¯æŒ‡å¯¼ AI ç”Ÿæˆ

### 5.3 æ½œåœ¨æ”¹è¿›æ–¹å‘

1. **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜å·²ç”Ÿæˆçš„ä»£ç†ï¼Œå‡å°‘ç£ç›˜ I/O
2. **ç‰ˆæœ¬æ§åˆ¶**: æ”¯æŒä»£ç†ç‰ˆæœ¬ç®¡ç†å’Œå›é€€
3. **æ€§èƒ½ç›‘æ§**: æ·»åŠ ä»£ç†æ‰§è¡Œæ—¶é—´å’Œ token æ¶ˆè€—ç»Ÿè®¡
4. **ä¾èµ–åˆ†æ**: è‡ªåŠ¨æ£€æµ‹ä»£ç†é—´çš„ä¾èµ–å…³ç³»
5. **æµ‹è¯•æ¡†æ¶**: æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
