# Tmux 终端复用器教程

## 一、何谓 Tmux

Tmux（Terminal Multiplexer）乃终端复用之神器，可于单一终端窗口中管理多个会话，断开后仍可保持运行，复连时状态不失。

## 二、安装之法

### macOS
```bash
brew install tmux
```

### Linux (Ubuntu/Debian)
```bash
sudo apt-get install tmux
```

### Linux (CentOS/RHEL)
```bash
sudo yum install tmux
```

### Windows (WSL)
```bash
sudo apt-get install tmux
```

## 三、基础结构

Tmux 之结构分三层：

1. **Session（会话）** - 最高层级，可包含多个窗口
2. **Window（窗口）** - 类似终端标签页，可包含多个面板
3. **Pane（面板）** - 窗口内分割的区域

```
Session (会话)
├── Window 0 (窗口 0)
│   ├── Pane 0 (面板 0)
│   └── Pane 1 (面板 1)
└── Window 1 (窗口 1)
    ├── Pane 0
    └── Pane 1
```

## 四、常用命令

### 4.1 前缀键

Tmux 默认前缀键为 `Ctrl+b`，所有快捷键都需先按此键。

### 4.2 会话操作

```bash
# 新建会话
tmux new-session -s mysession

# 分离当前会话（保持后台运行）
tmux detach
# 或按 Ctrl+b 然后 d

# 列出所有会话
tmux ls

# 连接到指定会话
tmux attach-session -t mysession
# 或
tmux a -t mysession

# 杀死指定会话
tmux kill-session -t mysession

# 重命名当前会话
Ctrl+b $
```

### 4.3 窗口操作

```bash
# 新建窗口
Ctrl+b c

# 切换到下一个窗口
Ctrl+b n

# 切换到上一个窗口
Ctrl+b p

# 列出所有窗口
Ctrl+b w

# 关闭当前窗口
Ctrl+b &

# 重命名当前窗口
Ctrl+b ,
```

### 4.4 面板操作

```bash
# 垂直分割面板
Ctrl+b "

# 水平分割面板
Ctrl+b %

# 切换到下一个面板
Ctrl+b o

# 切换到上一个面板
Ctrl+b ;

# 在面板间移动（方向键）
Ctrl+b 方向键

# 调整面板大小
Ctrl+b :resize-pane -D 10  # 向下扩展 10 行

# 关闭当前面板
Ctrl+b x

# 切换到指定面板（数字键）
Ctrl+b 0  # 切换到面板 0
Ctrl+b 1  # 切换到面板 1
```

## 五、复制模式

### 5.1 进入复制模式

```bash
Ctrl+b [
```

### 5.2 复制模式操作

```bash
# 移动光标（vim 模式）
h/j/k/l  # 左/下/上/右
w/b     # 前一个/后一个单词
0/$     # 行首/行尾
gg/G    # 文件首/文件尾

# 开始选择
Space

# 复制选择内容
Alt+w

# 粘贴
Ctrl+b ]
```

### 5.3 滚动操作

```bash
Ctrl+PageUp/PageDown  # 滚动半屏
Alt+PageUp/PageDown   # 滚动一屏
```

## 六、配置文件

### 6.1 配置文件位置

```bash
~/.tmux.conf  # 用户配置
/etc/tmux.conf # 全局配置
```

### 6.2 基础配置

```bash
# 设置前缀键为 Ctrl+a
set -g prefix C-a
unbind C-b

# 启用鼠标支持
set -g mouse on

# 设置面板边框颜色
set -g pane-border-style fg=green
set -g pane-active-border-style fg=brightgreen

# 设置状态栏
set -g status-left '#[fg=white,bg=blue] #S:#I.#P '
set -g status-right '#[fg=white,bg=blue] %Y-%m-%d %H:%M:%S'

# 启用 256 色支持
set -g default-terminal "screen-256color"
```

### 6.3 快捷键配置

```bash
# 垂直分割快捷键
bind | split-window -v -c "#{pane_current_path}"
bind - split-window -h

# 重新加载配置文件
bind r source-file ~/.tmux.conf \; display "配置已重新加载！"
```

## 七、实用技巧

### 7.1 保持会话运行

```bash
# SSH 连接后启动 tmux
tmux new -s work

# 分离会话（Ctrl+b d）
# 即使 SSH 断开，程序继续运行

# 重新连接
tmux a -t work
```

### 7.2 同时监控多个程序

```bash
# 创建会话
tmux new -s monitoring

# 垂直分割
Ctrl+b "

# 上半部分运行程序 1
npm run dev

# 切换到下半部分
Ctrl+b o

# 运行程序 2
npm run test
```

### 7.3 远程调试

```bash
# 在远程服务器启动 tmux
tmux new -s debug

# 运行调试程序
node --inspect app.js

# 分离会话，本地连接
tmux a -t debug
```

### 7.4 日志查看

```bash
# 创建日志查看会话
tmux new -s logs

# 分割多个面板，分别查看不同日志
Ctrl+b "  # 垂直分割
Ctrl+b %  # 水平分割

# 在各面板中
tail -f app.log
tail -f error.log
tail -f access.log
```

## 八、常见疑难

### 8.1 重复按下前缀键

**问题**：前缀键 `Ctrl+b` 需要按两次才能生效

**解决**：修改前缀键为 `Ctrl+a`
```bash
set -g prefix C-a
```

### 8.2 复制粘贴不工作

**问题**：复制模式下无法选择文本

**解决**：确保在复制模式下，使用 `Space` 开始选择，`Alt+w` 复制

### 8.3 面板大小调整困难

**问题**：调整面板大小不方便

**解决**：使用命令调整
```bash
Ctrl+b :resize-pane -D 10  # 向下扩展 10 行
```

### 8.4 无法滚动

**问题**：无法滚动查看长输出

**解决**：进入复制模式，然后滚动
```bash
Ctrl+b [
PageUp/PageDown  # 滚动半屏
```

### 8.5 会话丢失

**问题**：关闭终端后会话丢失

**解决**：先分离会话
```bash
tmux detach
# 或
Ctrl+b d
```

## 九、进阶插件

### 9.1 TPM (Tmux Plugin Manager)

```bash
# 安装 TPM
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm

# 在 ~/.tmux.conf 中添加
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-copycat'
```

### 9.2 Tmux-Resurrect（保存/恢复会话）

```bash
# 保存当前会话
Ctrl+b Ctrl+s

# 恢复会话
Ctrl+b Ctrl+r
```

### 9.3 Tmux-Continuum（自动保存窗口布局）

```bash
# 自动保存窗口位置和大小
set -g @plugin 'tmux-plugins/tmux-continuum'
```

## 十、命令速查

### 10.1 会话管理

```bash
tmux new -s name           # 新建会话
tmux ls                    # 列出会话
tmux a -t name            # 连接会话
tmux kill-ses -t name     # 杀死会话
tmux detach                # 分离会话
```

### 10.2 窗口管理

```bash
Ctrl+b c                  # 新建窗口
Ctrl+b n                  # 下一个窗口
Ctrl+b p                  # 上一个窗口
Ctrl+b w                  # 列出窗口
Ctrl+b &                  # 关闭窗口
Ctrl+b ,                  # 重命名窗口
```

### 10.3 面板管理

```bash
Ctrl+b "                  # 垂直分割
Ctrl+b %                  # 水平分割
Ctrl+b o                  # 切换面板
Ctrl+b x                  # 关闭面板
Ctrl+b 方向键              # 切换面板
Ctrl+b 0-9                # 切换到指定面板
```

### 10.4 复制粘贴

```bash
Ctrl+b [                  # 进入复制模式
Space                    # 开始选择
Alt+w                    # 复制
Ctrl+b ]                  # 粘贴
```

---

## 附录：推荐配置

### 完整配置文件 (~/.tmux.conf)

```bash
# 前缀键
set -g prefix C-a
unbind C-b

# 启用鼠标
set -g mouse on

# 面板边框
set -g pane-border-style fg=green
set -g pane-active-border-style fg=brightgreen

# 状态栏
set -g status-left '#[fg=white,bg=blue] #S:#I.#P '
set -g status-right '#[fg=white,bg=blue] %Y-%m-%d %H:%M:%S'
set -g status-justify centre
set -g status-position bottom

# 状态栏刷新间隔
set -g status-interval 1

# 窗口编号从 1 开始
set -g base-index 1

# 面板编号从 1 开始
set -g pane-base-index 1

# 启用 256 色
set -g default-terminal "screen-256color"

# 快捷键
bind | split-window -v -c "#{pane_current_path}"
bind - split-window -h
bind r source-file ~/.tmux.conf \; display "配置已重新加载！"

# 复制模式快捷键
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel-selection

# 垂直水平切换快捷键
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R
```

---

**完**