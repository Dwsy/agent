// Role Persona Extension Configuration
// Path: ~/.pi/agent/extensions/role-persona/pi-role-persona.jsonc
//
// 配置优先级（高到低）：
// 1. 环境变量（ROLE_*）
// 2. 本配置文件
// 3. 内置默认值

{
  // ==================== 自动记忆配置 ====================
  "autoMemory": {
    // 总开关：是否启用自动记忆提取
    // 环境变量覆盖：ROLE_AUTO_MEMORY
    "enabled": true,

    // 自动记忆提取使用的模型
    // 格式: "provider/model-id"
    // 环境变量覆盖：ROLE_AUTO_MEMORY_MODEL
    "model": "openai-codex/gpt-5.1-codex-mini",

    // 标签提取专用模型（默认继承 autoMemory.model）
    // 环境变量覆盖：ROLE_TAG_MODEL
    "tagModel": null,

    // Token 预算：为上下文预留的 token 数
    // 环境变量覆盖：ROLE_AUTO_MEMORY_RESERVE_TOKENS
    "reserveTokens": 8192,

    // 单次提取最多条目数（防止过度提取）
    "maxItems": 3,

    // 单条记忆最大字符数
    "maxText": 200,

    // Checkpoint 触发：累计轮数
    "batchTurns": 5,

    // 间隔触发：最小轮数（配合 intervalMs）
    "minTurns": 2,

    // 间隔触发：时间间隔（毫秒）
    // 默认 30 分钟
    "intervalMs": 1800000,

    // Flush 时保留的上下文重叠消息数
    "contextOverlap": 4
  },

  // ==================== 日志配置 ====================
  "logging": {
    // 是否启用日志
    // 环境变量覆盖：ROLE_LOG
    "enabled": true,

    // 日志级别: "debug" | "info" | "warn" | "error"
    "level": "info",

    // 日志保留天数（0 表示不自动清理）
    "retentionDays": 7
  },

  // ==================== 记忆管理配置 ====================
  "memory": {
    // 默认学习分类（用于 Preferences）
    "defaultCategories": [
      "Communication",
      "Code",
      "Tools",
      "Workflow",
      "General"
    ],

    // 每日记忆文件路径模板
    // 变量: {rolePath}, {date}
    "dailyPathTemplate": "{rolePath}/memory/{date}.md",

    // 记忆去重相似度阈值（0-1，Jaccard 系数）
    "dedupeThreshold": 0.9,

    // 按需搜索：第一条消息时根据内容自动搜索相关记忆
    "onDemandSearch": {
      // 是否启用（默认 true）
      "enabled": true,
      // 最大返回结果数
      "maxResults": 5,
      // 最小匹配分数（0-1）
      "minScore": 0.2,
      // 始终加载 High Priority 记忆（作为基础上下文）
      "alwaysLoadHighPriority": true
    },

    // 搜索默认参数
    "searchDefaults": {
      "maxResults": 20,
      "minScore": 0.1,
      "includeDailyMemory": true
    }
  },

  // ==================== UI 配置 ====================
  "ui": {
    // Checkpoint 动画帧间隔（毫秒）
    "spinnerIntervalMs": 260,

    // Checkpoint 动画帧符号
    "spinnerFrames": ["✳", "✶", "✧", "✦"],

    // 记忆查看器默认过滤
    // "all" | "learnings" | "preferences" | "events"
    "viewerDefaultFilter": "all"
  },

  // ==================== 高级配置 ====================
  "advanced": {
    // 会话关闭时 flush 的最大等待时间（毫秒）
    "shutdownFlushTimeoutMs": 1500,

    // 检查点触发的强制关键词（正则表达式字符串）
    "forceKeywords": "结束|总结|退出|收尾|结束会话|final|summary|wrap\\s?up|quit|exit",

    // 自动整理：进化提醒间隔（每 N 轮触发一次）
    "evolutionReminderTurns": 5
  },

  // ==================== 向量记忆配置 ====================
  "vectorMemory": {
    // 总开关：是否启用向量语义搜索
    // 环境变量覆盖：ROLE_VECTOR_MEMORY
    // 需要 @lancedb/lancedb 依赖和 OpenAI API key
    "enabled": false,

    // Embedding 提供商（目前仅支持 openai）
    "provider": "openai",

    // Embedding 模型
    // text-embedding-3-small (1536维, $0.02/1M tokens)
    // text-embedding-3-large (3072维, $0.13/1M tokens)
    "model": "text-embedding-3-small",

    // 显式 API key（默认从 modelRegistry 自动获取 OpenAI key）
    // 环境变量覆盖：ROLE_VECTOR_API_KEY
    "apiKey": null,

    // 自动召回：before_agent_start 时语义搜索注入上下文
    "autoRecall": true,

    // 自动索引：写入记忆时同步生成向量索引
    "autoIndex": true,

    // 混合搜索：关键词 + 向量 → RRF 融合排序
    "hybridSearch": true,

    // 向量搜索在 RRF 融合中的权重（1.0 = 等权）
    "vectorWeight": 1.0,

    // 自动召回：最大返回条数
    "recallLimit": 3,

    // 自动召回：最低相似度阈值
    "recallMinScore": 0.3,

    // 向量数据库存储路径（相对于 rolePath）
    "dbPath": ".vector-db"
  }
}
