# Hash Trigger - 项目结论

## 项目目标

为 pi-coding-agent 实现基于 `#` 前缀的快速命令系统，提供类似 `@` 和 `/` 的自动完成体验。

## 核心需求

用户要求：
- 输入 `#` 后立即显示自动完成建议
- 继续输入字母时实时过滤
- 支持键盘导航选择
- 体验必须与 `@` 和 `/` 完全一致

## 尝试的方案

### 方案 1: 扩展 + Monkey Patch ❌

**尝试：** 在扩展中运行时修改 `CombinedAutocompleteProvider`

**结果：** 失败
- Provider 在扩展加载前已实例化
- 无法在运行时替换

### 方案 2: 修改 pi 源码 ❌

**尝试：** 直接修改 `autocomplete.js` 和 `editor.js`

**结果：** 技术上成功，但用户不接受
- 修改了两个文件：
  - `autocomplete.js` - 添加 `#` 命令检测和补全
  - `editor.js` - 添加 `#` 触发逻辑
- 自动完成功能完全正常
- 但存在问题：
  - 直接输入 `#` 不稳定（需要先输入 `@` 再删除）
  - pi 更新后修改会被覆盖
  - **用户明确表示不能修改源码**

### 方案 3: 输入拦截 + UI 选择器 ❌

**尝试：** 使用 `pi.on('input')` 拦截 `#` 输入，显示 `ctx.ui.select()`

**结果：** 不符合需求
- 不是真正的自动完成
- 需要额外的交互步骤
- 体验与 `@` 和 `/` 不一致

## 技术限制

### 核心问题

pi 的自动完成系统由以下组件构成：

1. **CombinedAutocompleteProvider** (autocomplete.js)
   - 负责生成建议列表
   - 只支持 `/` 和 `@` 前缀
   - 在 `InteractiveMode` 启动时实例化

2. **Editor** (editor.js)
   - 负责触发自动完成
   - `insertCharacter` 方法中硬编码了 `/` 和 `@` 的触发逻辑
   - 没有扩展点可以添加新的触发前缀

3. **扩展系统限制**
   - 扩展无法修改已实例化的 Provider
   - 扩展无法修改 Editor 的触发逻辑
   - `setEditorComponent` 只能在特定时机调用，且不稳定

### 为什么扩展无法实现

1. **时机问题**
   - 扩展加载时，Editor 和 Provider 已经初始化
   - 无法在运行时替换

2. **API 限制**
   - pi 没有提供 `registerAutocompletePrefix` API
   - 扩展无法注册自定义的 autocomplete 触发器

3. **架构限制**
   - 自动完成逻辑深度集成在核心组件中
   - 没有设计扩展点

## 结论

**在不修改 pi 源码的前提下，无法实现真正的 `#` 自动完成功能。**

### 原因

1. pi 的自动完成系统没有为扩展提供注册自定义前缀的 API
2. Editor 的触发逻辑硬编码在源码中
3. 扩展系统的能力有限，无法修改核心组件的行为

### 唯一可行的方案

**修改 pi 源码**，但用户明确表示不能修改源码。

## 建议

### 短期方案

放弃此项目，等待 pi 官方支持。

### 长期方案

向 pi 项目提交 Feature Request 或 PR：

1. **添加扩展 API**
   ```typescript
   pi.registerAutocompletePrefix(prefix: string, provider: AutocompleteProvider)
   ```

2. **修改 Editor**
   - 将触发逻辑改为可配置
   - 允许扩展注册自定义触发前缀

3. **修改 CombinedAutocompleteProvider**
   - 支持动态添加前缀处理器
   - 提供扩展点

## 保留的文档

- `PRD.md` - 完整的产品需求文档
- `docs/` - 详细的设计文档（10+ 篇）

这些文档可以作为：
1. 向 pi 提交 Feature Request 的参考
2. 未来实现的设计基础
3. 其他开发者的参考资料

## 最终状态

**项目状态：** 已终止

**原因：** 技术限制 + 用户约束（不能修改源码）

**结论：** 在当前 pi 架构下，通过扩展无法实现真正的 `#` 自动完成功能。

---

*2024-01-26*

*"有些功能，需要框架本身的支持。"*
