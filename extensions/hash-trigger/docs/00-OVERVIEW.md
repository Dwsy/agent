# Hash Trigger 架构概览

## 设计理念

**核心思想**：基于 `#` 符号的快速命令系统，充分利用现代 CLI 工具，提供高性能、可扩展的交互体验。

## 设计原则

### 1. 插件化优先
- 每个命令都是独立的插件
- 易于添加、删除、禁用命令
- 命令之间互不干扰

### 2. 利用现有工具
- **不重新造轮**：优先使用成熟的 CLI 工具
- **性能优先**：fzf、rg、fd 等工具已经高度优化
- **用户友好**：用户可能已经熟悉这些工具

### 3. 渐进式增强
- 基础功能不依赖外部工具
- 检测到工具时自动启用增强功能
- 提供降级方案

### 4. 配置驱动
- 用户可以自定义命令
- 可以配置工具路径
- 可以禁用不需要的功能

## 架构分层

```
┌─────────────────────────────────────┐
│         用户输入层                    │
│  (#file, #search, #git, ...)        │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         输入拦截层                    │
│  - 检测 # 前缀                       │
│  - 解析命令和参数                     │
│  - 路由到对应处理器                   │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         命令注册表                    │
│  - 命令注册                          │
│  - 命令查找                          │
│  - 命令元数据                        │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         命令执行层                    │
│  - 参数验证                          │
│  - 工具检测                          │
│  - 执行命令                          │
│  - 结果处理                          │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         工具集成层                    │
│  - fzf (模糊搜索)                    │
│  - rg (代码搜索)                     │
│  - fd (文件查找)                     │
│  - bat (文件预览)                    │
│  - git (版本控制)                    │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         结果展示层                    │
│  - 格式化输出                        │
│  - 注入到对话                        │
│  - 状态反馈                          │
└─────────────────────────────────────┘
```

## 核心模块

### 1. 输入拦截器 (Interceptor)
- 监听 `input` 事件
- 检测 `#` 前缀
- 解析命令和参数
- 决定是否拦截

### 2. 命令注册表 (Registry)
- 存储所有命令
- 提供命令查找
- 管理命令元数据
- 支持动态注册

### 3. 命令处理器 (Handler)
- 执行命令逻辑
- 调用外部工具
- 处理结果
- 错误处理

### 4. 工具管理器 (ToolManager)
- 检测工具是否安装
- 缓存工具路径
- 提供统一调用接口
- 处理工具版本差异

### 5. UI 组件 (UI Components)
- 文件选择器
- 搜索结果展示
- 预览窗口
- 进度指示

### 6. 配置管理器 (ConfigManager)
- 加载用户配置
- 合并默认配置
- 验证配置
- 热重载

## 命令生命周期

```
用户输入 #file src/
    ↓
拦截器检测到 # 前缀
    ↓
解析命令: file, 参数: src/
    ↓
查找命令注册表
    ↓
找到 file 命令处理器
    ↓
检测依赖工具 (fd, fzf, bat)
    ↓
执行命令逻辑
    ↓
调用 fd 查找文件
    ↓
调用 fzf 让用户选择
    ↓
调用 bat 预览文件
    ↓
用户确认选择
    ↓
读取文件内容
    ↓
格式化输出
    ↓
注入到对话上下文
    ↓
完成
```

## 扩展点

### 1. 命令扩展
- 用户可以添加自定义命令
- 支持 TypeScript/JavaScript
- 支持配置文件定义

### 2. 工具扩展
- 可以添加新的 CLI 工具集成
- 可以自定义工具参数
- 可以提供工具别名

### 3. UI 扩展
- 可以自定义选择器样式
- 可以自定义预览格式
- 可以添加新的交互组件

### 4. 配置扩展
- 支持项目级配置
- 支持用户级配置
- 支持环境变量覆盖

## 性能考虑

### 1. 工具检测缓存
- 首次检测后缓存结果
- 避免重复执行 `which`
- 支持手动刷新缓存

### 2. 命令结果缓存
- 缓存文件列表
- 缓存搜索结果
- 设置合理的过期时间

### 3. 异步执行
- 所有工具调用都是异步的
- 支持取消操作
- 显示进度反馈

### 4. 增量加载
- 大文件分块读取
- 搜索结果分页显示
- 按需加载预览

## 下一步

接下来将详细设计各个模块：

1. **01-INTERCEPTOR.md** - 输入拦截器设计
2. **02-REGISTRY.md** - 命令注册表设计
3. **03-COMMANDS.md** - 内置命令设计
4. **04-TOOLS.md** - 工具集成设计
5. **05-UI.md** - UI 组件设计
6. **06-CONFIG.md** - 配置系统设计
7. **07-EXTENSION.md** - 扩展机制设计
