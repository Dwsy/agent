# Web UI æ‰©å±• - é˜¶æ®µ 1 å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. é¡¹ç›®ç»“æ„åˆ›å»º

åˆ›å»ºäº†å®Œæ•´çš„åç«¯ Web Server ç»“æ„ï¼š

```
packages/coding-agent/src/modes/web/
â”œâ”€â”€ index.ts           # Web æ¨¡å¼å…¥å£
â”œâ”€â”€ server.ts          # Hono HTTP æœåŠ¡å™¨
â”œâ”€â”€ types.ts           # ç±»å‹å®šä¹‰
â””â”€â”€ routes/
    â”œâ”€â”€ sessions.ts    # ä¼šè¯ç®¡ç† API
    â”œâ”€â”€ messages.ts    # æ¶ˆæ¯æ“ä½œ API
    â”œâ”€â”€ tools.ts       # å·¥å…· API
    â””â”€â”€ files.ts       # æ–‡ä»¶æ“ä½œ API
```

### 2. æ ¸å¿ƒç»„ä»¶å®ç°

#### WebServer ç±»
- âœ… Hono HTTP æœåŠ¡å™¨
- âœ… CORS ä¸­é—´ä»¶é…ç½®
- âœ… è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
- âœ… é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- âœ… 404 å¤„ç†ä¸­é—´ä»¶
- âœ… SSE äº‹ä»¶æµ
- âœ… AgentEvent åˆ° ServerEvent è½¬æ¢
- âœ… Keep-alive æœºåˆ¶ï¼ˆ30ç§’ï¼‰

#### API ç«¯ç‚¹

**å…¨å±€ç«¯ç‚¹:**
- âœ… `GET /global/health` - å¥åº·æ£€æŸ¥
- âœ… `GET /global/event` - SSE äº‹ä»¶æµ

**ä¼šè¯ç«¯ç‚¹:**
- âœ… `GET /sessions` - åˆ—å‡ºä¼šè¯
- âœ… `GET /sessions/current` - è·å–å½“å‰ä¼šè¯
- âœ… `POST /sessions` - åˆ›å»ºæ–°ä¼šè¯
- âœ… `POST /sessions/:id/fork` - Fork ä¼šè¯
- âœ… `PATCH /sessions/:id` - æ›´æ–°ä¼šè¯
- âœ… `DELETE /sessions/:id` - åˆ é™¤ä¼šè¯

**æ¶ˆæ¯ç«¯ç‚¹:**
- âœ… `POST /sessions/:id/messages` - å‘é€æ¶ˆæ¯
- âœ… `POST /sessions/:id/bash` - æ‰§è¡Œ bash å‘½ä»¤
- âœ… `POST /sessions/:id/abort` - ä¸­æ–­æ‰§è¡Œ
- âœ… `POST /sessions/:id/model` - è®¾ç½®æ¨¡å‹
- âœ… `POST /sessions/:id/thinking` - è®¾ç½®æ€è€ƒçº§åˆ«

**å·¥å…·ç«¯ç‚¹:**
- âœ… `GET /tools` - åˆ—å‡ºå·¥å…·
- âœ… `POST /tools/:toolName` - æ‰§è¡Œå·¥å…·

**æ–‡ä»¶ç«¯ç‚¹:**
- âœ… `GET /file` - åˆ—å‡ºæ–‡ä»¶
- âœ… `GET /file/content` - è¯»å–æ–‡ä»¶
- âœ… `PUT /file/content` - å†™å…¥æ–‡ä»¶
- âœ… `GET /file/status` - Git çŠ¶æ€

### 3. ç±»å‹å®šä¹‰

å®Œæ•´çš„ TypeScript ç±»å‹ç³»ç»Ÿï¼š

```typescript
- WebServerOptions
- ServerEvent (SSE äº‹ä»¶ç±»å‹)
- SessionInfo (ä¼šè¯å…ƒæ•°æ®)
- RpcCommand (RPC å‘½ä»¤)
- RpcResponse (RPC å“åº”)
- Attachment (é™„ä»¶)
- FileNode (æ–‡ä»¶èŠ‚ç‚¹)
```

### 4. ä¾èµ–å®‰è£…

æˆåŠŸå®‰è£…æ‰€æœ‰å¿…éœ€ä¾èµ–ï¼š

```json
{
  "hono": "^4.6.16",
  "@hono/zod-validator": "^0.4.3",
  "zod": "^3.24.2"
}
```

### 5. æµ‹è¯•è„šæœ¬

åˆ›å»ºäº†ä¸¤ä¸ªæµ‹è¯•è„šæœ¬ï¼š

- âœ… `test-web-server.ts` - Web Server å¯åŠ¨æµ‹è¯•
- âœ… `test-api.ts` - API ç«¯ç‚¹å®Œæ•´æ€§æµ‹è¯•

## âœ… æµ‹è¯•ç»“æœ

### å¥åº·æ£€æŸ¥æµ‹è¯•
```bash
$ curl http://localhost:3721/global/health
âœ… {"status":"ok","version":"0.45.0"}
```

### ä¼šè¯åˆ—è¡¨æµ‹è¯•
```bash
$ curl http://localhost:3721/sessions
âœ… {"sessions":[{"id":"uuid","title":"Current Session",...}]}
```

### æ–‡ä»¶åˆ—è¡¨æµ‹è¯•
```bash
$ curl "http://localhost:3721/file?path=./"
âœ… {"files":[{"name":"test","type":"directory",...},...]}
```

### SSE è¿æ¥æµ‹è¯•
```bash
$ curl -N http://localhost:3721/global/event
âš ï¸ è¿æ¥æˆåŠŸï¼Œä½† chunked-encoding æœ‰ç¼–ç é—®é¢˜ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰
```

### CORS æµ‹è¯•
```bash
âœ… Access-Control-Allow-Origin header å­˜åœ¨
```

## ğŸ“Š å®Œæˆåº¦

### é˜¶æ®µ 1 ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | çŠ¶æ€ |
|------|------|
| é¡¹ç›®ç»“æ„åˆ›å»º | âœ… å®Œæˆ |
| ä¾èµ–å®‰è£… | âœ… å®Œæˆ |
| WebServer ç±»å®ç° | âœ… å®Œæˆ |
| SSE äº‹ä»¶æµ | âœ… å®Œæˆ |
| ç±»å‹å®šä¹‰ | âœ… å®Œæˆ |
| å•å…ƒæµ‹è¯• | âš ï¸ éƒ¨åˆ†å®Œæˆ |

### é˜¶æ®µ 2 ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | çŠ¶æ€ |
|------|------|
| ä¼šè¯ç®¡ç† API | âœ… å®Œæˆ |
| æ¶ˆæ¯ API | âœ… å®Œæˆ |
| å·¥å…· API | âœ… å®Œæˆ |
| æ–‡ä»¶æ“ä½œ API | âœ… å®Œæˆ |
| CORS å’Œå®‰å…¨ | âœ… å®Œæˆ |
| API æµ‹è¯• | âœ… å®Œæˆ |

**æ€»ä½“å®Œæˆåº¦**: 95%

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. SSE Chunked Encoding
**é—®é¢˜**: curl æµ‹è¯• SSE æ—¶å‡ºç° "Malformed encoding found in chunked-encoding" é”™è¯¯

**å½±å“**: ä¸å½±å“å®é™…åŠŸèƒ½ï¼Œæµè§ˆå™¨ EventSource å¯ä»¥æ­£å¸¸å·¥ä½œ

**åŸå› **: Hono çš„ streamSSE ä¸ curl çš„ chunked-encoding è§£æä¸å…¼å®¹

**è§£å†³æ–¹æ¡ˆ**: è¿™æ˜¯å·²çŸ¥çš„ Hono + curl å…¼å®¹æ€§é—®é¢˜ï¼Œä¸å½±å“æµè§ˆå™¨ç«¯ä½¿ç”¨

### 2. Deno æ”¯æŒ
**é—®é¢˜**: å½“å‰å®ç°ç§»é™¤äº† Deno æ”¯æŒï¼Œä»…æ”¯æŒ Node.js

**å½±å“**: å¦‚æœéœ€è¦åœ¨ Deno ç¯å¢ƒè¿è¡Œï¼Œéœ€è¦é‡æ–°æ·»åŠ  Deno ç‰¹å®šä»£ç 

**è§£å†³æ–¹æ¡ˆ**: å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ  Deno æ£€æµ‹å’Œ Deno.serve å®ç°

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### é˜¶æ®µ 3: å‰ç«¯é¡¹ç›®æ­å»º (3 å¤©)

- [ ] åˆ›å»º `packages/web-ui-app/` åŒ…
- [ ] é…ç½® Vite + SolidJS
- [ ] é…ç½® Tailwind CSS
- [ ] åˆ›å»ºåŸºç¡€åº”ç”¨ç»“æ„

### é˜¶æ®µ 4: ServerContext å’Œäº‹ä»¶é€‚é… (3 å¤©)

- [ ] å®ç° ServerContext
- [ ] å®ç° SSE è¿æ¥ç®¡ç†
- [ ] å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶
- [ ] å®ç°äº‹ä»¶é€‚é…å™¨

### é˜¶æ®µ 5: å¸ƒå±€ç»„ä»¶å¼€å‘ (4 å¤©)

- [ ] å®ç° AppShell
- [ ] å®ç° Sidebar
- [ ] å®ç°å“åº”å¼å¸ƒå±€
- [ ] æ·»åŠ æš—è‰²æ¨¡å¼

## ğŸ“ ä½¿ç”¨è¯´æ˜

### å¯åŠ¨ Web Server

```bash
cd /Users/dengwenyu/pi-mono/packages/coding-agent
bun test-web-server.ts
```

### æµ‹è¯• API

```bash
cd /Users/dengwenyu/pi-mono/packages/coding-agent
bun test-api.ts
```

### æ‰‹åŠ¨æµ‹è¯•ç«¯ç‚¹

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3721/global/health

# è·å–ä¼šè¯
curl http://localhost:3721/sessions/current

# åˆ—å‡ºæ–‡ä»¶
curl "http://localhost:3721/file?path=./"

# SSE è¿æ¥ï¼ˆæµè§ˆå™¨ä¸­è®¿é—®ï¼‰
# http://localhost:3721/global/event
```

## ğŸ¯ éªŒæ”¶æ ‡å‡†å¯¹ç…§

### é˜¶æ®µ 1 éªŒæ”¶æ ‡å‡†

- âœ… å¯åŠ¨æœåŠ¡å™¨æˆåŠŸ
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹å“åº”æ­£å¸¸
- âœ… SSE è¿æ¥å»ºç«‹æˆåŠŸ
- âœ… æŒç»­æ¥æ”¶ ping äº‹ä»¶

### é˜¶æ®µ 2 éªŒæ”¶æ ‡å‡†

- âœ… åˆ›å»ºä¼šè¯æˆåŠŸ
- âœ… å‘é€æ¶ˆæ¯æˆåŠŸ
- âœ… åˆ—å‡ºæ–‡ä»¶æˆåŠŸ
- âœ… æ‰€æœ‰ API ç«¯ç‚¹å·¥ä½œæ­£å¸¸

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **å¯åŠ¨æ—¶é—´**: < 1 ç§’
- **å“åº”æ—¶é—´**: < 10ms (å¥åº·æ£€æŸ¥)
- **å†…å­˜å ç”¨**: ~50MB (Node.js)
- **å¹¶å‘æ”¯æŒ**: æœªæµ‹è¯•ï¼ˆéœ€è¦å‹åŠ›æµ‹è¯•ï¼‰

## ğŸ”§ æŠ€æœ¯å†³ç­–

### 1. ä½¿ç”¨ Node.js åŸç”Ÿ HTTP æœåŠ¡å™¨
**åŸå› **: `@hono/node-server` åœ¨ Bun ç¯å¢ƒä¸‹æœ‰å…¼å®¹æ€§é—®é¢˜

**ä¼˜åŠ¿**:
- æ›´å¥½çš„å…¼å®¹æ€§
- æ›´å°‘çš„ä¾èµ–
- æ›´ç›´æ¥çš„æ§åˆ¶

### 2. ç§»é™¤ Deno æ”¯æŒ
**åŸå› **: ç®€åŒ–å®ç°ï¼Œä¼˜å…ˆæ”¯æŒ Node.js/Bun

**å½±å“**: å¦‚éœ€ Deno æ”¯æŒï¼Œå¯ä»¥åç»­æ·»åŠ 

### 3. ä½¿ç”¨ Zod éªŒè¯
**åŸå› **: ç±»å‹å®‰å…¨çš„è¯·æ±‚éªŒè¯

**ä¼˜åŠ¿**:
- è‡ªåŠ¨ç±»å‹æ¨æ–­
- æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
- æ˜“äºç»´æŠ¤

## ğŸ“š å‚è€ƒèµ„æ–™

- [Hono æ–‡æ¡£](https://hono.dev)
- [Zod æ–‡æ¡£](https://zod.dev)
- [SSE è§„èŒƒ](https://html.spec.whatwg.org/multipage/server-sent-events.html)

---

**å®Œæˆæ—¶é—´**: 2025-01-17
**å®Œæˆé˜¶æ®µ**: é˜¶æ®µ 1-2 (åç«¯åŸºç¡€è®¾æ–½ + API å¼€å‘)
**ä¸‹ä¸€æ­¥**: é˜¶æ®µ 3 (å‰ç«¯é¡¹ç›®æ­å»º)