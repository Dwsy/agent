# Handoff 提示词模板

> 参考: https://nicolaygerold.com/posts/how-i-built-handoff-in-amp
> 核心思路: 不依赖 /compact 的摘要，而是结构化提取关键上下文

---

## 核心原理

原作者的核心洞察:
1. `/compact` 的问题是**丢失指令**——模型生成的摘要会遗漏用户的具体要求
2. Handoff 应该做**信息提取**任务——这是模型擅长的
3. 格式: `相关文件 + 相关信息 + 用户目标` → 模型提取
4. 通过收集**好/坏案例**迭代优化提示词

---

## 使用方式

### 方式1: 生成本次会话的 Handoff
```
请基于我们的对话，生成一份 Handoff 文档
```

### 方式2: 指定目标接手
```
请生成 Handoff，目标是让新会话能够【具体目标，如：修复剩下的 3 个 bug】
```

---

## 提示词内容（可直接复制使用）

```
你是一位专业的项目交接助手。请从当前会话中提取关键上下文，生成结构化的 Handoff 文档。

## 输入格式（我会提供）

```
## 相关文件
[会话中涉及的所有文件路径和内容片段]

## 会话历史
[重要的对话摘要]

## Handoff 目标
[新会话需要完成什么]
```

## 你的任务：信息提取

从上述内容中提取以下结构化信息：

### 1. Mission（任务）
- 我们在做什么？（一句话）
- 最终目标是什么？
- 为什么重要？

### 2. Status（状态）
- ✅ 已完成：具体完成了什么（文件/功能/测试）
- 🚧 进行中：正在做什么，进展到哪里
- ⏸️ 阻塞点：卡在哪里，需要什么才能继续
- 📋 下一步：新会话应该做的第一件事

### 3. Decisions（决策）
- 做了哪些技术选择？为什么？
- 讨论过哪些方案？放弃了什么？为什么？
- 有哪些约束？（性能、兼容性、时间）

### 4. Context（上下文）
- 关键文件路径（绝对路径，可复制）
- 关键代码片段（只保留核心部分）
- 环境/配置信息
- 外部依赖/API

### 5. Tradeoffs（权衡）
- 做过什么取舍？
- 有哪些技术债？
- 哪些是临时方案，后续需要重构？

### 6. Unknowns（未知）
- 有哪些假设？
- 哪些信息不确定？
- 需要验证什么？

## 输出格式

```markdown
# Handoff: [任务名称]
**生成时间**: [YYYY-MM-DD HH:MM]
**状态**: [进行中/阻塞/待 review]

---

## Mission
[一句话描述]

## Status
| 状态 | 内容 |
|------|------|
| ✅ 已完成 | ... |
| 🚧 进行中 | ... |
| ⏸️ 阻塞点 | ... |
| 📋 下一步 | ... |

## Decisions
1. **【决策名称】**: 【决策内容】
   - 原因: ...
   - 备选方案: ...

## Context
### 关键文件
- `绝对路径/文件.ts`

### 关键代码
```ts
// 核心代码片段
```

## Tradeoffs
- 【取舍】: 【原因和后果】

## Unknowns
- 【假设】: 【为什么不确定】
```

## 重要规则

1. **具体 > 抽象**: "修复了 UserService 第 42 行的内存泄漏" 优于 "做了优化"
2. **路径 > 描述**: 提供可复制的绝对路径
3. **可执行 > 概念**: 下一步应该是具体的、可立即执行的动作
4. **诚实面对未知**: 明确标注不确定的假设，不要编造
5. **保留用户意图**: 确保用户的具体要求被记录，不要丢失
```

---

## 进阶：迭代优化提示词

原作者的方法：

1. **收集案例**: 记录哪些 handoff 成功，哪些失败
2. **建立 Playground**: 批量测试不同对话的 handoff 效果
3. **分析失败模式**: 用表格记录失败原因
4. **逐个修复**: 一次解决一个问题，重新跑所有案例
5. **持续迭代**: 不断优化提示词

### 失败模式检查清单

- [ ] 丢失了用户的具体指令？
- [ ] 遗漏了中间讨论的文件？
- [ ] 没有记录技术权衡？
- [ ] 下一步不够具体？
- [ ] 丢失了放弃的方案？
- [ ] 约束条件没记录？

---

## 快捷触发方式

### 在 pi 中配置为自定义命令

在 `~/.pi/agent/config.json` 中添加:

```json
{
  "customCommands": {
    "handoff": {
      "description": "生成会话交接文档",
      "prompt": "你是一位专业的项目交接助手..."
    }
  }
}
```

### 或使用扩展

将此提示词保存为 `~/.pi/agent/extensions/handoff.ts`，实现 `/handoff` 命令。

---

## 与 /compact 的区别

| 特性 | /compact | /handoff |
|------|----------|----------|
| 信息密度 | 高（摘要） | 结构化完整 |
| 指令保留 | ❌ 容易丢失 | ✅ 明确记录 |
| 上下文深度 | 浅 | 深（含决策原因）|
| 可操作性 | 低 | 高（可执行下一步）|
| 交接成功率 | 低 | 高 |

---

## 最佳实践

### 1. 定期生成
- 每 30-60 分钟或每个里程碑生成一次
- 在重要决策后立即生成
- 在准备中断工作前必生成

### 2. 保存到文件
将 handoff 文档写入 `docs/handoff/[YYYYMMDD]-[brief-task-name].md`：

```bash
# 格式: YYYYMMDD-简短任务名称.md
# 示例文件名
docs/handoff/20260206-auth-refactor.md
docs/handoff/20260206-api-integration.md
```

命名规则：
- 日期前缀：YYYYMMDD
- 任务名称：2-4 个词，kebab-case
- 避免使用 -1 -2 编号，用描述性名称区分

### 3. 与 Workhub 集成
在 Workhub Issue 中引用 handoff 文档：

```markdown
## Handoff Documents
- [20260206 认证重构](docs/handoff/20260206-auth-refactor.md)
- [20260206 API集成](docs/handoff/20260206-api-integration.md)
```

### 4. 新会话接手流程
1. 先读 handoff 文档
2. 再读关键文件
3. 确认理解无误后再行动
4. 如有疑问，先澄清再继续

---

## 快捷触发方式

### 在 pi 中配置为自定义命令

在 `~/.pi/agent/config.json` 中添加：

```json
{
  "customCommands": {
    "handoff": {
      "description": "生成会话交接文档",
      "promptFile": "prompts/handoff.md"
    }
  }
}
```

### 或使用扩展

参考 `~/.pi/agent/extensions/handoff.ts` 实现 `/handoff` 命令。

---

## 参考

- 原文: https://nicolaygerold.com/posts/how-i-built-handoff-in-amp
- 工具: Amp (https://ampcode.com)
